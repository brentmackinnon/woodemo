"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("@php-wasm/scopes"),h=25e3;let f=0;function y(e,t,...s){const n=d();return e.postMessage({...t,requestId:n},...s),n}function d(){return++f}function u(e,t,s=h){return new Promise((n,c)=>{const r=a=>{a.data.type==="response"&&a.data.requestId===t&&(e.removeEventListener("message",r),clearTimeout(o),n(a.data.response))},o=setTimeout(()=>{c(new Error("Request timed out")),e.removeEventListener("message",r)},s);e.addEventListener("message",r)})}function R(e,t){return{type:"response",requestId:e,response:t}}async function g(e){let t=new URL(e.request.url);if(!i.isURLScoped(t))try{const o=new URL(e.request.referrer);t=i.setURLScope(t,i.getURLScope(o))}catch{}const s=e.request.headers.get("content-type"),n=e.request.method==="POST"?new Uint8Array(await e.request.clone().arrayBuffer()):void 0,c={};for(const o of e.request.headers.entries())c[o[0]]=o[1];let r;try{const o={method:"request",args:[{body:n,url:t.toString(),method:e.request.method,headers:{...c,Host:t.host,"User-agent":self.navigator.userAgent,"Content-type":s}}]},a=i.getURLScope(t);if(a===null)throw new Error(`The URL ${t.toString()} is not scoped. This should not happen.`);const p=await l(o,a);r=await u(self,p),delete r.headers["x-frame-options"]}catch(o){throw console.error(o,{url:t.toString()}),o}return r.httpStatusCode>=300&&r.httpStatusCode<=399&&r.headers.location?Response.redirect(r.headers.location[0],r.httpStatusCode):new Response(r.bytes,{headers:r.headers,status:r.httpStatusCode})}async function l(e,t){const s=d();for(const n of await self.clients.matchAll({includeUncontrolled:!0}))n.postMessage({...e,scope:t,requestId:s});return s}async function m(e,t){const s=["GET","HEAD"].includes(e.method)||"body"in t?void 0:await e.blob();return new Request(t.url||e.url,{body:s,method:e.method,headers:e.headers,referrer:e.referrer,referrerPolicy:e.referrerPolicy,mode:e.mode==="navigate"?"same-origin":e.mode,credentials:e.credentials,cache:e.cache,redirect:e.redirect,integrity:e.integrity,...t})}function E(e){const t={};return e.headers.forEach((s,n)=>{t[n]=s}),t}exports.awaitReply=u;exports.broadcastMessageExpectReply=l;exports.cloneRequest=m;exports.convertFetchEventToPHPRequest=g;exports.getNextRequestId=d;exports.getRequestHeaders=E;exports.postMessageExpectReply=y;exports.responseTo=R;
