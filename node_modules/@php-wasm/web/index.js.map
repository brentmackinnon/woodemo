{"version":3,"file":"index.js","sources":["../../../../packages/php-wasm/web/src/lib/api.ts","../../../../packages/php-wasm/web/src/lib/get-php-loader-module.ts","../../../../packages/php-wasm/web/src/lib/tls/utils.ts","../../../../packages/php-wasm/web/src/lib/tls/extensions/types.ts","../../../../packages/php-wasm/web/src/lib/tls/extensions/0_server_name.ts","../../../../packages/php-wasm/web/src/lib/tls/cipher-suites.ts","../../../../packages/php-wasm/web/src/lib/tls/extensions/10_supported_groups.ts","../../../../packages/php-wasm/web/src/lib/tls/extensions/11_ec_point_formats.ts","../../../../packages/php-wasm/web/src/lib/tls/extensions/13_signature_algorithms.ts","../../../../packages/php-wasm/web/src/lib/tls/extensions/parse-extensions.ts","../../../../packages/php-wasm/web/src/lib/tls/1_2/prf.ts","../../../../packages/php-wasm/web/src/lib/tls/1_2/types.ts","../../../../packages/php-wasm/web/src/lib/tls/1_2/connection.ts","../../../../packages/php-wasm/web/src/lib/tls/certificates.ts","../../../../packages/php-wasm/web/src/lib/fetch-with-cors-proxy.ts","../../../../packages/php-wasm/web/src/lib/tcp-over-fetch-websocket.ts","../../../../packages/php-wasm/web/src/lib/load-runtime.ts","../../../../packages/php-wasm/web/src/lib/setup-post-message-relay.ts","../../../../packages/php-wasm/web/src/lib/worker-thread/spawn-php-worker-thread.ts","../../../../packages/php-wasm/web/src/lib/directory-handle-mount.ts"],"sourcesContent":["import { PHPResponse, PHPResponseData } from '@php-wasm/universal';\nimport * as Comlink from 'comlink';\n\nexport type WithAPIState = {\n\t/**\n\t * Resolves to true when the remote API is ready for\n\t * Comlink communication, but not necessarily fully initialized yet.\n\t */\n\tisConnected: () => Promise<void>;\n\t/**\n\t * Resolves to true when the remote API is declares it's\n\t * fully loaded and ready to be used.\n\t */\n\tisReady: () => Promise<void>;\n};\nexport type RemoteAPI<T> = Comlink.Remote<T> & WithAPIState;\n\nexport function consumeAPI<APIType>(\n\tremote: Worker | Window,\n\tcontext: undefined | EventTarget = undefined\n): RemoteAPI<APIType> {\n\tsetupTransferHandlers();\n\n\tconst endpoint =\n\t\tremote instanceof Worker\n\t\t\t? remote\n\t\t\t: Comlink.windowEndpoint(remote, context);\n\n\t/**\n\t * This shouldn't be necessary, but Comlink doesn't seem to\n\t * handle the initial isConnected() call correctly unless it's\n\t * explicitly provided here. This is especially weird\n\t * since the only thing this proxy does is to call the\n\t * isConnected() method on the remote API.\n\t *\n\t * @TODO: Remove this workaround.\n\t */\n\tconst api = Comlink.wrap<APIType & WithAPIState>(endpoint);\n\tconst methods = proxyClone(api);\n\treturn new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn async () => {\n\t\t\t\t\t// Keep retrying until the remote API confirms it's connected.\n\t\t\t\t\twhile (true) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait runWithTimeout(api.isConnected(), 200);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t// Timeout exceeded, try again. We can't just use a single\n\t\t\t\t\t\t\t// `runWithTimeout` call because it won't reach the remote API\n\t\t\t\t\t\t\t// if it's not connected yet. Instead, we need to keep retrying\n\t\t\t\t\t\t\t// until the remote API is connected and registers a handler\n\t\t\t\t\t\t\t// for the `isConnected` method.\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn (api as any)[prop];\n\t\t},\n\t}) as unknown as RemoteAPI<APIType>;\n}\n\nasync function runWithTimeout<T>(\n\tpromise: Promise<T>,\n\ttimeout: number\n): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\tsetTimeout(reject, timeout);\n\t\tpromise.then(resolve);\n\t});\n}\n\nexport type PublicAPI<Methods, PipedAPI = unknown> = RemoteAPI<\n\tMethods & PipedAPI\n>;\nexport function exposeAPI<Methods, PipedAPI>(\n\tapiMethods?: Methods,\n\tpipedApi?: PipedAPI\n): [() => void, (e: Error) => void, PublicAPI<Methods, PipedAPI>] {\n\tsetupTransferHandlers();\n\n\tconst connected = Promise.resolve();\n\n\tlet setReady: any;\n\tlet setFailed: any;\n\tconst ready = new Promise((resolve, reject) => {\n\t\tsetReady = resolve;\n\t\tsetFailed = reject;\n\t});\n\n\tconst methods = proxyClone(apiMethods);\n\tconst exposedApi = new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn () => connected;\n\t\t\t} else if (prop === 'isReady') {\n\t\t\t\treturn () => ready;\n\t\t\t} else if (prop in target) {\n\t\t\t\treturn target[prop];\n\t\t\t}\n\t\t\treturn (pipedApi as any)?.[prop];\n\t\t},\n\t}) as unknown as PublicAPI<Methods, PipedAPI>;\n\n\tComlink.expose(\n\t\texposedApi,\n\t\ttypeof window !== 'undefined'\n\t\t\t? Comlink.windowEndpoint(self.parent)\n\t\t\t: undefined\n\t);\n\treturn [setReady, setFailed, exposedApi];\n}\n\nlet isTransferHandlersSetup = false;\nfunction setupTransferHandlers() {\n\tif (isTransferHandlersSetup) {\n\t\treturn;\n\t}\n\tisTransferHandlersSetup = true;\n\tComlink.transferHandlers.set('EVENT', {\n\t\tcanHandle: (obj): obj is CustomEvent => obj instanceof CustomEvent,\n\t\tserialize: (ev: CustomEvent) => {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tdetail: ev.detail,\n\t\t\t\t},\n\t\t\t\t[],\n\t\t\t];\n\t\t},\n\t\tdeserialize: (obj) => obj,\n\t});\n\tComlink.transferHandlers.set('FUNCTION', {\n\t\tcanHandle: (obj: unknown): obj is Function => typeof obj === 'function',\n\t\tserialize(obj: Function) {\n\t\t\tconst { port1, port2 } = new MessageChannel();\n\t\t\tComlink.expose(obj, port1);\n\t\t\treturn [port2, [port2]];\n\t\t},\n\t\tdeserialize(port: any) {\n\t\t\tport.start();\n\t\t\treturn Comlink.wrap(port);\n\t\t},\n\t});\n\tComlink.transferHandlers.set('PHPResponse', {\n\t\tcanHandle: (obj: unknown): obj is PHPResponseData =>\n\t\t\ttypeof obj === 'object' &&\n\t\t\tobj !== null &&\n\t\t\t'headers' in obj &&\n\t\t\t'bytes' in obj &&\n\t\t\t'errors' in obj &&\n\t\t\t'exitCode' in obj &&\n\t\t\t'httpStatusCode' in obj,\n\t\tserialize(obj: PHPResponse): [PHPResponseData, Transferable[]] {\n\t\t\treturn [obj.toRawData(), []];\n\t\t},\n\t\tdeserialize(responseData: PHPResponseData): PHPResponse {\n\t\t\treturn PHPResponse.fromRawData(responseData);\n\t\t},\n\t});\n\t// Augment Comlink's throw handler to include Error the response and source\n\t// information in the serialized error object. BasePHP may throw\n\t// PHPExecutionFailureError which includes those information and we'll want to\n\t// display them for the user.\n\tconst throwHandler = Comlink.transferHandlers.get('throw')!;\n\tconst originalSerialize = throwHandler?.serialize;\n\tthrowHandler.serialize = ({ value }: any) => {\n\t\tconst serialized = originalSerialize({ value }) as any;\n\t\tif (value.response) {\n\t\t\tserialized[0].value.response = value.response;\n\t\t}\n\t\tif (value.source) {\n\t\t\tserialized[0].value.source = value.source;\n\t\t}\n\t\treturn serialized;\n\t};\n}\n\nfunction proxyClone(object: any): any {\n\treturn new Proxy(object, {\n\t\tget(target, prop) {\n\t\t\tswitch (typeof target[prop]) {\n\t\t\t\tcase 'function':\n\t\t\t\t\treturn (...args: any[]) => target[prop](...args);\n\t\t\t\tcase 'object':\n\t\t\t\t\tif (target[prop] === null) {\n\t\t\t\t\t\treturn target[prop];\n\t\t\t\t\t}\n\t\t\t\t\treturn proxyClone(target[prop]);\n\t\t\t\tcase 'undefined':\n\t\t\t\tcase 'number':\n\t\t\t\tcase 'string':\n\t\t\t\t\treturn target[prop];\n\t\t\t\tdefault:\n\t\t\t\t\treturn Comlink.proxy(target[prop]);\n\t\t\t}\n\t\t},\n\t});\n}\n","import {\n\tLatestSupportedPHPVersion,\n\tPHPLoaderModule,\n\tSupportedPHPVersion,\n} from '@php-wasm/universal';\nimport { jspi } from 'wasm-feature-detect';\n\n/**\n * Loads the PHP loader module for the given PHP version.\n *\n * @param version The PHP version to load.\n * @param variant Internal. Do not use.\n * @returns The PHP loader module.\n */\nexport async function getPHPLoaderModule(\n\tversion: SupportedPHPVersion = LatestSupportedPHPVersion\n): Promise<PHPLoaderModule> {\n\tif (await jspi()) {\n\t\tswitch (version) {\n\t\t\tcase '8.4':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_8_4.js');\n\t\t\tcase '8.3':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_8_3.js');\n\t\t\tcase '8.2':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_8_2.js');\n\t\t\tcase '8.1':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_8_1.js');\n\t\t\tcase '8.0':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_8_0.js');\n\t\t\tcase '7.4':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_7_4.js');\n\t\t\tcase '7.3':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_7_3.js');\n\t\t\tcase '7.2':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_7_2.js');\n\t\t\tcase '7.1':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_7_1.js');\n\t\t\tcase '7.0':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/jspi/php_7_0.js');\n\t\t}\n\t} else {\n\t\tswitch (version) {\n\t\t\tcase '8.4':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_8_4.js');\n\t\t\tcase '8.3':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_8_3.js');\n\t\t\tcase '8.2':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_8_2.js');\n\t\t\tcase '8.1':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_8_1.js');\n\t\t\tcase '8.0':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_8_0.js');\n\t\t\tcase '7.4':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_7_4.js');\n\t\t\tcase '7.3':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_7_3.js');\n\t\t\tcase '7.2':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_7_2.js');\n\t\t\tcase '7.1':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_7_1.js');\n\t\t\tcase '7.0':\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn await import('../../public/php/asyncify/php_7_0.js');\n\t\t}\n\t}\n\tthrow new Error(`Unsupported PHP version ${version}`);\n}\n","export function flipObject(obj: Record<any, any>) {\n\treturn Object.fromEntries(Object.entries(obj).map(([k, v]) => [v, k]));\n}\n\nexport function concatUint8Arrays(arrays: Uint8Array[]): Uint8Array {\n\tlet totalLength = 0;\n\tarrays.forEach((a) => (totalLength += a.length));\n\tconst result = new Uint8Array(totalLength);\n\tlet offset = 0;\n\tarrays.forEach((a) => {\n\t\tresult.set(a, offset);\n\t\toffset += a.length;\n\t});\n\treturn result;\n}\n\nexport function concatArrayBuffers(buffers: ArrayBuffer[]): ArrayBuffer {\n\treturn concatUint8Arrays(buffers.map((b) => new Uint8Array(b))).buffer;\n}\n\nexport function as2Bytes(value: number): Uint8Array {\n\treturn new Uint8Array([(value >> 8) & 0xff, value & 0xff]);\n}\n\nexport function as3Bytes(value: number): Uint8Array {\n\treturn new Uint8Array([\n\t\t(value >> 16) & 0xff,\n\t\t(value >> 8) & 0xff,\n\t\tvalue & 0xff,\n\t]);\n}\n\nexport function as8Bytes(value: number): Uint8Array {\n\tconst buffer = new ArrayBuffer(8);\n\tconst view = new DataView(buffer);\n\tview.setBigUint64(0, BigInt(value), false); // false for big-endian\n\treturn new Uint8Array(buffer);\n}\nexport class ArrayBufferReader {\n\tprivate view: DataView;\n\toffset = 0;\n\tconstructor(private buffer: ArrayBuffer) {\n\t\tthis.view = new DataView(buffer);\n\t}\n\n\treadUint8(): number {\n\t\tconst value = this.view.getUint8(this.offset);\n\t\tthis.offset += 1;\n\t\treturn value;\n\t}\n\treadUint16(): number {\n\t\tconst value = this.view.getUint16(this.offset);\n\t\tthis.offset += 2;\n\t\treturn value;\n\t}\n\treadUint32(): number {\n\t\tconst value = this.view.getUint32(this.offset);\n\t\tthis.offset += 4;\n\t\treturn value;\n\t}\n\treadUint8Array(length: number): Uint8Array {\n\t\tconst value = this.buffer.slice(this.offset, this.offset + length);\n\t\tthis.offset += length;\n\t\treturn new Uint8Array(value);\n\t}\n\n\tisFinished() {\n\t\treturn this.offset >= this.buffer.byteLength;\n\t}\n}\n\nexport class ArrayBufferWriter {\n\tbuffer: ArrayBuffer;\n\tview: DataView;\n\tuint8Array: Uint8Array;\n\n\tprivate offset = 0;\n\n\tconstructor(length: number) {\n\t\tthis.buffer = new ArrayBuffer(length);\n\t\tthis.uint8Array = new Uint8Array(this.buffer);\n\t\tthis.view = new DataView(this.buffer);\n\t}\n\n\twriteUint8(value: number) {\n\t\tthis.view.setUint8(this.offset, value);\n\t\tthis.offset += 1;\n\t}\n\n\twriteUint16(value: number) {\n\t\tthis.view.setUint16(this.offset, value);\n\t\tthis.offset += 2;\n\t}\n\n\twriteUint32(value: number) {\n\t\tthis.view.setUint32(this.offset, value);\n\t\tthis.offset += 4;\n\t}\n\n\twriteUint8Array(value: Uint8Array) {\n\t\tthis.uint8Array.set(value, this.offset);\n\t\tthis.offset += value.length;\n\t}\n}\n","/**\n * IANA maintains a list of TLS extensions here:\n * https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml\n */\nexport const ExtensionTypes = {\n\tserver_name: 0,\n\tmax_fragment_length: 1,\n\tclient_certificate_url: 2,\n\ttrusted_ca_keys: 3,\n\ttruncated_hmac: 4,\n\tstatus_request: 5,\n\tuser_mapping: 6,\n\tclient_authz: 7,\n\tserver_authz: 8,\n\tcert_type: 9,\n\tsupported_groups: 10,\n\tec_point_formats: 11,\n\tsrp: 12,\n\tsignature_algorithms: 13,\n\tuse_srtp: 14,\n\theartbeat: 15,\n\tapplication_layer_protocol_negotiation: 16,\n\tstatus_request_v2: 17,\n\tsigned_certificate_timestamp: 18,\n\tclient_certificate_type: 19,\n\tserver_certificate_type: 20,\n\tpadding: 21,\n\tencrypt_then_mac: 22,\n\textended_master_secret: 23,\n\ttoken_binding: 24,\n\tcached_info: 25,\n\ttls_its: 26,\n\tcompress_certificate: 27,\n\trecord_size_limit: 28,\n\tpwd_protect: 29,\n\tpwo_clear: 30,\n\tpassword_salt: 31,\n\tticket_pinning: 32,\n\ttls_cert_with_extern_psk: 33,\n\tdelegated_credential: 34,\n\tsession_ticket: 35,\n\tTLMSP: 36,\n\tTLMSP_proxying: 37,\n\tTLMSP_delegate: 38,\n\tsupported_ekt_ciphers: 39,\n\tpre_shared_key: 41,\n\tearly_data: 42,\n\tsupported_versions: 43,\n\tcookie: 44,\n\tpsk_key_exchange_modes: 45,\n\treserved: 46,\n\tcertificate_authorities: 47,\n\toid_filters: 48,\n\tpost_handshake_auth: 49,\n\tsignature_algorithms_cert: 50,\n\tkey_share: 51,\n\ttransparency_info: 52,\n\tconnection_id: 54,\n} as const;\n\nimport { flipObject } from '../utils';\n\nexport type ExtensionType = keyof typeof ExtensionTypes;\n\nexport const ExtensionNames = flipObject(ExtensionTypes);\nexport type ExtensionName = keyof typeof ExtensionNames;\n","/**\n * TLS server_name extension\n * https://www.rfc-editor.org/rfc/rfc6066.html\n */\n\nimport { ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport interface ServerNameList {\n\tserver_name_list: ServerName[];\n}\n\nexport interface ServerName {\n\tname_type: typeof ServerNameTypes;\n\tname: {\n\t\thost_name: string;\n\t};\n}\n\nexport const ServerNameTypes = {\n\thost_name: 0,\n} as const;\nexport type ServerNameType =\n\t(typeof ServerNameTypes)[keyof typeof ServerNameTypes];\nexport const ServerNameNames = flipObject(ServerNameTypes);\n\nexport class ServerNameExtension {\n\tstatic decodeFromClient(data: Uint8Array): ServerNameList {\n\t\tconst view = new DataView(data.buffer);\n\t\tlet offset = 0;\n\n\t\tconst listLength = view.getUint16(offset);\n\t\toffset += 2;\n\n\t\tconst serverNameList: ServerName[] = [];\n\n\t\twhile (offset < listLength + 2) {\n\t\t\tconst nameType = data[offset] as ServerNameType;\n\t\t\toffset += 1;\n\n\t\t\tconst valueLength = view.getUint16(offset);\n\t\t\toffset += 2;\n\n\t\t\tconst value = data.slice(offset, offset + valueLength);\n\t\t\toffset += valueLength;\n\n\t\t\tswitch (nameType) {\n\t\t\t\tcase ServerNameTypes.host_name:\n\t\t\t\t\tserverNameList.push({\n\t\t\t\t\t\tname_type: ServerNameNames[nameType],\n\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\thost_name: new TextDecoder().decode(value),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error(`Unsupported name type ${nameType}`);\n\t\t\t}\n\t\t}\n\n\t\treturn { server_name_list: serverNameList };\n\t}\n\n\t/**\n\t * Encode the server_name extension\n\t *\n\t * +------------------------------------+\n\t * | Extension Type (server_name) [2B]  |\n\t * | 0x00 0x00                          |\n\t * +------------------------------------+\n\t * | Extension Length             [2B]  |\n\t * | 0x00 0x00                          |\n\t * +------------------------------------+\n\t */\n\tstatic encodeForClient(serverNames?: ServerNameList) {\n\t\tif (serverNames?.server_name_list.length) {\n\t\t\tthrow new Error(\n\t\t\t\t'Encoding non-empty lists for ClientHello is not supported yet. ' +\n\t\t\t\t\t'Only empty lists meant for ServerHello are supported today.'\n\t\t\t);\n\t\t}\n\n\t\tconst writer = new ArrayBufferWriter(4);\n\t\twriter.writeUint16(ExtensionTypes.server_name);\n\t\t// Zero body length encoded using two bytes\n\t\twriter.writeUint16(0);\n\t\treturn writer.uint8Array;\n\t}\n}\n","import { flipObject } from './utils';\n\n/**\n * TLS1 cipher suites sourced from OpenSSL:\n *\n * https://github.com/openssl/openssl/blob/36254fda37fe169e136079404a3c32aeea35cbd4/include/openssl/tls1.h#L371\n */\nexport const CipherSuites = {\n\tTLS1_CK_PSK_WITH_RC4_128_SHA: 0x008a,\n\tTLS1_CK_PSK_WITH_3DES_EDE_CBC_SHA: 0x008b,\n\tTLS1_CK_PSK_WITH_AES_128_CBC_SHA: 0x008c,\n\tTLS1_CK_PSK_WITH_AES_256_CBC_SHA: 0x008d,\n\tTLS1_CK_DHE_PSK_WITH_RC4_128_SHA: 0x008e,\n\tTLS1_CK_DHE_PSK_WITH_3DES_EDE_CBC_SHA: 0x008f,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CBC_SHA: 0x0090,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CBC_SHA: 0x0091,\n\tTLS1_CK_RSA_PSK_WITH_RC4_128_SHA: 0x0092,\n\tTLS1_CK_RSA_PSK_WITH_3DES_EDE_CBC_SHA: 0x0093,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_CBC_SHA: 0x0094,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_CBC_SHA: 0x0095,\n\tTLS1_CK_PSK_WITH_AES_128_GCM_SHA256: 0x00a8,\n\tTLS1_CK_PSK_WITH_AES_256_GCM_SHA384: 0x00a9,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_GCM_SHA256: 0x00aa,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_GCM_SHA384: 0x00ab,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_GCM_SHA256: 0x00ac,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_GCM_SHA384: 0x00ad,\n\tTLS1_CK_PSK_WITH_AES_128_CBC_SHA256: 0x00ae,\n\tTLS1_CK_PSK_WITH_AES_256_CBC_SHA384: 0x00af,\n\tTLS1_CK_PSK_WITH_NULL_SHA256: 0x00b0,\n\tTLS1_CK_PSK_WITH_NULL_SHA384: 0x00b1,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CBC_SHA256: 0x00b2,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CBC_SHA384: 0x00b3,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA256: 0x00b4,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA384: 0x00b5,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_CBC_SHA256: 0x00b6,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_CBC_SHA384: 0x00b7,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA256: 0x00b8,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA384: 0x00b9,\n\tTLS1_CK_PSK_WITH_NULL_SHA: 0x002c,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA: 0x002d,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA: 0x002e,\n\tTLS1_CK_RSA_WITH_AES_128_SHA: 0x002f,\n\tTLS1_CK_DH_DSS_WITH_AES_128_SHA: 0x0030,\n\tTLS1_CK_DH_RSA_WITH_AES_128_SHA: 0x0031,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_SHA: 0x0032,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_SHA: 0x0033,\n\tTLS1_CK_ADH_WITH_AES_128_SHA: 0x0034,\n\tTLS1_CK_RSA_WITH_AES_256_SHA: 0x0035,\n\tTLS1_CK_DH_DSS_WITH_AES_256_SHA: 0x0036,\n\tTLS1_CK_DH_RSA_WITH_AES_256_SHA: 0x0037,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_SHA: 0x0038,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_SHA: 0x0039,\n\tTLS1_CK_ADH_WITH_AES_256_SHA: 0x003a,\n\tTLS1_CK_RSA_WITH_NULL_SHA256: 0x003b,\n\tTLS1_CK_RSA_WITH_AES_128_SHA256: 0x003c,\n\tTLS1_CK_RSA_WITH_AES_256_SHA256: 0x003d,\n\tTLS1_CK_DH_DSS_WITH_AES_128_SHA256: 0x003e,\n\tTLS1_CK_DH_RSA_WITH_AES_128_SHA256: 0x003f,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_SHA256: 0x0040,\n\tTLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0041,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA: 0x0042,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0043,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA: 0x0044,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0045,\n\tTLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA: 0x0046,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_SHA256: 0x0067,\n\tTLS1_CK_DH_DSS_WITH_AES_256_SHA256: 0x0068,\n\tTLS1_CK_DH_RSA_WITH_AES_256_SHA256: 0x0069,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_SHA256: 0x006a,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_SHA256: 0x006b,\n\tTLS1_CK_ADH_WITH_AES_128_SHA256: 0x006c,\n\tTLS1_CK_ADH_WITH_AES_256_SHA256: 0x006d,\n\tTLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0084,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA: 0x0085,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0086,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA: 0x0087,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0088,\n\tTLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA: 0x0089,\n\tTLS1_CK_RSA_WITH_SEED_SHA: 0x0096,\n\tTLS1_CK_DH_DSS_WITH_SEED_SHA: 0x0097,\n\tTLS1_CK_DH_RSA_WITH_SEED_SHA: 0x0098,\n\tTLS1_CK_DHE_DSS_WITH_SEED_SHA: 0x0099,\n\tTLS1_CK_DHE_RSA_WITH_SEED_SHA: 0x009a,\n\tTLS1_CK_ADH_WITH_SEED_SHA: 0x009b,\n\tTLS1_CK_RSA_WITH_AES_128_GCM_SHA256: 0x009c,\n\tTLS1_CK_RSA_WITH_AES_256_GCM_SHA384: 0x009d,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_GCM_SHA256: 0x009e,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_GCM_SHA384: 0x009f,\n\tTLS1_CK_DH_RSA_WITH_AES_128_GCM_SHA256: 0x00a0,\n\tTLS1_CK_DH_RSA_WITH_AES_256_GCM_SHA384: 0x00a1,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_GCM_SHA256: 0x00a2,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_GCM_SHA384: 0x00a3,\n\tTLS1_CK_DH_DSS_WITH_AES_128_GCM_SHA256: 0x00a4,\n\tTLS1_CK_DH_DSS_WITH_AES_256_GCM_SHA384: 0x00a5,\n\tTLS1_CK_ADH_WITH_AES_128_GCM_SHA256: 0x00a6,\n\tTLS1_CK_ADH_WITH_AES_256_GCM_SHA384: 0x00a7,\n\tTLS1_CK_RSA_WITH_AES_128_CCM: 0xc09c,\n\tTLS1_CK_RSA_WITH_AES_256_CCM: 0xc09d,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_CCM: 0xc09e,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_CCM: 0xc09f,\n\tTLS1_CK_RSA_WITH_AES_128_CCM_8: 0xc0a0,\n\tTLS1_CK_RSA_WITH_AES_256_CCM_8: 0xc0a1,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_CCM_8: 0xc0a2,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_CCM_8: 0xc0a3,\n\tTLS1_CK_PSK_WITH_AES_128_CCM: 0xc0a4,\n\tTLS1_CK_PSK_WITH_AES_256_CCM: 0xc0a5,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CCM: 0xc0a6,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CCM: 0xc0a7,\n\tTLS1_CK_PSK_WITH_AES_128_CCM_8: 0xc0a8,\n\tTLS1_CK_PSK_WITH_AES_256_CCM_8: 0xc0a9,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CCM_8: 0xc0aa,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CCM_8: 0xc0ab,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CCM: 0xc0ac,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CCM: 0xc0ad,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CCM_8: 0xc0ae,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CCM_8: 0xc0af,\n\tTLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00ba,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA256: 0x00bb,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00bc,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA256: 0x00bd,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00be,\n\tTLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA256: 0x00bf,\n\tTLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c0,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA256: 0x00c1,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c2,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA256: 0x00c3,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c4,\n\tTLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA256: 0x00c5,\n\tTLS1_CK_ECDH_ECDSA_WITH_NULL_SHA: 0xc001,\n\tTLS1_CK_ECDH_ECDSA_WITH_RC4_128_SHA: 0xc002,\n\tTLS1_CK_ECDH_ECDSA_WITH_DES_192_CBC3_SHA: 0xc003,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_CBC_SHA: 0xc004,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_CBC_SHA: 0xc005,\n\tTLS1_CK_ECDHE_ECDSA_WITH_NULL_SHA: 0xc006,\n\tTLS1_CK_ECDHE_ECDSA_WITH_RC4_128_SHA: 0xc007,\n\tTLS1_CK_ECDHE_ECDSA_WITH_DES_192_CBC3_SHA: 0xc008,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CBC_SHA: 0xc009,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CBC_SHA: 0xc00a,\n\tTLS1_CK_ECDH_RSA_WITH_NULL_SHA: 0xc00b,\n\tTLS1_CK_ECDH_RSA_WITH_RC4_128_SHA: 0xc00c,\n\tTLS1_CK_ECDH_RSA_WITH_DES_192_CBC3_SHA: 0xc00d,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_CBC_SHA: 0xc00e,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_CBC_SHA: 0xc00f,\n\tTLS1_CK_ECDHE_RSA_WITH_NULL_SHA: 0xc010,\n\tTLS1_CK_ECDHE_RSA_WITH_RC4_128_SHA: 0xc011,\n\tTLS1_CK_ECDHE_RSA_WITH_DES_192_CBC3_SHA: 0xc012,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_CBC_SHA: 0xc013,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_CBC_SHA: 0xc014,\n\tTLS1_CK_ECDH_anon_WITH_NULL_SHA: 0xc015,\n\tTLS1_CK_ECDH_anon_WITH_RC4_128_SHA: 0xc016,\n\tTLS1_CK_ECDH_anon_WITH_DES_192_CBC3_SHA: 0xc017,\n\tTLS1_CK_ECDH_anon_WITH_AES_128_CBC_SHA: 0xc018,\n\tTLS1_CK_ECDH_anon_WITH_AES_256_CBC_SHA: 0xc019,\n\tTLS1_CK_SRP_SHA_WITH_3DES_EDE_CBC_SHA: 0xc01a,\n\tTLS1_CK_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA: 0xc01b,\n\tTLS1_CK_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA: 0xc01c,\n\tTLS1_CK_SRP_SHA_WITH_AES_128_CBC_SHA: 0xc01d,\n\tTLS1_CK_SRP_SHA_RSA_WITH_AES_128_CBC_SHA: 0xc01e,\n\tTLS1_CK_SRP_SHA_DSS_WITH_AES_128_CBC_SHA: 0xc01f,\n\tTLS1_CK_SRP_SHA_WITH_AES_256_CBC_SHA: 0xc020,\n\tTLS1_CK_SRP_SHA_RSA_WITH_AES_256_CBC_SHA: 0xc021,\n\tTLS1_CK_SRP_SHA_DSS_WITH_AES_256_CBC_SHA: 0xc022,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_SHA256: 0xc023,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_SHA384: 0xc024,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_SHA256: 0xc025,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_SHA384: 0xc026,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_SHA256: 0xc027,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_SHA384: 0xc028,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_SHA256: 0xc029,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_SHA384: 0xc02a,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256: 0xc02b,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384: 0xc02c,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_GCM_SHA256: 0xc02d,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_GCM_SHA384: 0xc02e,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256: 0xc02f,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_GCM_SHA384: 0xc030,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_GCM_SHA256: 0xc031,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_GCM_SHA384: 0xc032,\n\tTLS1_CK_ECDHE_PSK_WITH_RC4_128_SHA: 0xc033,\n\tTLS1_CK_ECDHE_PSK_WITH_3DES_EDE_CBC_SHA: 0xc034,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA: 0xc035,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA: 0xc036,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA256: 0xc037,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA384: 0xc038,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA: 0xc039,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA256: 0xc03a,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA384: 0xc03b,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc072,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc073,\n\tTLS1_CK_ECDH_ECDSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc074,\n\tTLS1_CK_ECDH_ECDSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc075,\n\tTLS1_CK_ECDHE_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc076,\n\tTLS1_CK_ECDHE_RSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc077,\n\tTLS1_CK_ECDH_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc078,\n\tTLS1_CK_ECDH_RSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc079,\n\tTLS1_CK_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc094,\n\tTLS1_CK_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc095,\n\tTLS1_CK_DHE_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc096,\n\tTLS1_CK_DHE_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc097,\n\tTLS1_CK_RSA_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc098,\n\tTLS1_CK_RSA_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc099,\n\tTLS1_CK_ECDHE_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc09a,\n\tTLS1_CK_ECDHE_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc09b,\n\tTLS1_CK_ECDHE_RSA_WITH_CHACHA20_POLY1305: 0xcca8,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CHACHA20_POLY1305: 0xcca9,\n\tTLS1_CK_DHE_RSA_WITH_CHACHA20_POLY1305: 0xccaa,\n\tTLS1_CK_PSK_WITH_CHACHA20_POLY1305: 0xccab,\n\tTLS1_CK_ECDHE_PSK_WITH_CHACHA20_POLY1305: 0xccac,\n\tTLS1_CK_DHE_PSK_WITH_CHACHA20_POLY1305: 0xccad,\n\tTLS1_CK_RSA_PSK_WITH_CHACHA20_POLY1305: 0xccae,\n} as const;\n\nexport const CipherSuitesNames = flipObject(CipherSuites);\n","/**\n * TLS supported_groups extension\n * https://www.iana.org/go/rfc7919\n * https://www.iana.org/go/rfc8422\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport const SupportedGroups = {\n\tsecp256r1: 23,\n\tsecp384r1: 24,\n\tsecp521r1: 25,\n\tx25519: 29,\n\tx448: 30,\n} as const;\nexport const SupportedGroupsNames = flipObject(SupportedGroups);\nexport type SupportedGroup = keyof typeof SupportedGroups;\n\nexport type ParsedSupportedGroups = (keyof typeof SupportedGroups)[];\n\nexport class SupportedGroupsExtension {\n\t/**\n\t * +--------------------------------------------------+\n\t * | Payload Length                            [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Groups List Length              [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Group 1                         [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Group 2                         [2B]   |\n\t * +--------------------------------------------------+\n\t * | ...                                              |\n\t * +--------------------------------------------------+\n\t * | Supported Group n                         [2B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedSupportedGroups {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\t// Skip the length field\n\t\treader.readUint16();\n\t\tconst groups = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst group = reader.readUint16();\n\t\t\tif (!(group in SupportedGroupsNames)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tgroups.push(SupportedGroupsNames[group]);\n\t\t}\n\t\treturn groups;\n\t}\n\n\t/**\n\t * +--------------------------------------------------+\n\t * | Extension Type (supported_groups)         [2B]   |\n\t * | 0x00 0x0A                                        |\n\t * +--------------------------------------------------+\n\t * | Extension Length                          [2B]   |\n\t * +--------------------------------------------------+\n\t * | Selected Group                            [2B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeForClient(group: SupportedGroup): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.supported_groups);\n\t\twriter.writeUint16(2);\n\t\twriter.writeUint16(SupportedGroups[group]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS ec_point_formats extension\n * https://www.rfc-editor.org/rfc/rfc4492#section-5.1.2\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport const ECPointFormats = {\n\tuncompressed: 0,\n\tansiX962_compressed_prime: 1,\n\tansiX962_compressed_char2: 2,\n} as const;\nexport type ECPointFormat = keyof typeof ECPointFormats;\n\nexport const ECPointFormatNames = flipObject(ECPointFormats);\n\nexport type ParsedECPointFormats = (keyof typeof ECPointFormats)[];\n\nexport class ECPointFormatsExtension {\n\t/**\n\t * +--------------------------------------------------+\n\t * | Payload Length                            [2B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Formats Length                   [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format 1                         [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format 2                         [1B]   |\n\t * +--------------------------------------------------+\n\t * | ...                                              |\n\t * +--------------------------------------------------+\n\t * | EC Point Format n                         [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedECPointFormats {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\t// Read the EC Point Formats Length\n\t\tconst length = reader.readUint8();\n\t\tconst formats = [];\n\t\tfor (let i = 0; i < length; i++) {\n\t\t\tconst format = reader.readUint8();\n\t\t\tif (format in ECPointFormatNames) {\n\t\t\t\tformats.push(ECPointFormatNames[format]);\n\t\t\t}\n\t\t}\n\t\treturn formats;\n\t}\n\n\t/**\n\t * Encode the ec_point_formats extension\n\t *\n\t * +--------------------------------------------------+\n\t * | Extension Type (ec_point_formats)         [2B]   |\n\t * | 0x00 0x0B                                        |\n\t * +--------------------------------------------------+\n\t * | Body Length                               [2B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format Length                    [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format                           [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeForClient(format: ECPointFormat): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.ec_point_formats);\n\t\twriter.writeUint16(2); // Body length\n\t\twriter.writeUint8(1); // EC Point Formats Length\n\t\twriter.writeUint8(ECPointFormats[format]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS signature_algorithms extension\n * https://www.rfc-editor.org/rfc/rfc8446.html#page-41\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * A list of supported signature algorithms,\n * one byte per algorithm.\n */\nexport type SignatureAlgorithms = Uint8Array;\n\n/**\n * Signature algorithms from\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1\n */\nexport const SignatureAlgorithms = {\n\tanonymous: 0,\n\trsa: 1,\n\tdsa: 2,\n\tecdsa: 3,\n};\nexport type SignatureAlgorithm = keyof typeof SignatureAlgorithms;\nexport const SignatureAlgorithmsNames = flipObject(SignatureAlgorithms);\n\n/**\n * Hash algorithms from\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1\n */\nexport const HashAlgorithms = {\n\tnone: 0,\n\tmd5: 1,\n\tsha1: 2,\n\tsha224: 3,\n\tsha256: 4,\n\tsha384: 5,\n\tsha512: 6,\n};\nexport type HashAlgorithm = keyof typeof HashAlgorithms;\nexport const HashAlgorithmsNames = flipObject(HashAlgorithms);\n\nexport type ParsedSignatureAlgorithm = {\n\thash: HashAlgorithm;\n\talgorithm: SignatureAlgorithm;\n};\n\n/**\n * Handles the signature algorithms extension as defined in\n * https://www.rfc-editor.org/rfc/rfc8446.html#page-41\n */\nexport class SignatureAlgorithmsExtension {\n\t/**\n\t * Binary layout:\n\t *\n\t * +------------------------------------+\n\t * | Payload Length              [2B]   |\n\t * +------------------------------------+\n\t * | Hash Algorithm 1            [1B]   |\n\t * | Signature Algorithm 1       [1B]   |\n\t * +------------------------------------+\n\t * | Hash Algorithm 2            [1B]   |\n\t * | Signature Algorithm 2       [1B]   |\n\t * +------------------------------------+\n\t * | ...                                |\n\t * +------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedSignatureAlgorithm[] {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\treader.readUint16(); // Skip algorithms length\n\t\tconst parsedAlgorithms: ParsedSignatureAlgorithm[] = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst hash = reader.readUint8();\n\t\t\tconst algorithm = reader.readUint8();\n\t\t\tif (!SignatureAlgorithmsNames[algorithm]) {\n\t\t\t\tlogger.warn(`Unknown signature algorithm: ${algorithm}`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!HashAlgorithmsNames[hash]) {\n\t\t\t\tlogger.warn(`Unknown hash algorithm: ${hash}`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tparsedAlgorithms.push({\n\t\t\t\talgorithm: SignatureAlgorithmsNames[algorithm],\n\t\t\t\thash: HashAlgorithmsNames[hash],\n\t\t\t});\n\t\t}\n\t\treturn parsedAlgorithms;\n\t}\n\n\t/**\n\t * +--------------------------------------------------+\n\t * | Extension Type (signature_algorithms)     [2B]   |\n\t * | 0x00 0x0D                                        |\n\t * +--------------------------------------------------+\n\t * | Body Length                               [2B]   |\n\t * +--------------------------------------------------+\n\t * | Hash Algorithm                            [1B]   |\n\t * | Signature Algorithm                       [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeforClient(\n\t\thash: HashAlgorithm,\n\t\talgorithm: SignatureAlgorithm\n\t): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.signature_algorithms);\n\t\twriter.writeUint16(2);\n\t\twriter.writeUint8(HashAlgorithms[hash]);\n\t\twriter.writeUint8(SignatureAlgorithms[algorithm]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * Glue for the implemented TLS extensions\n * For the full list of TLS extensions, see\n * https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml */\nimport { ArrayBufferReader } from '../utils';\nimport { ServerNameExtension, ServerNameList } from './0_server_name';\nimport {\n\tParsedSupportedGroups,\n\tSupportedGroupsExtension,\n} from './10_supported_groups';\nimport {\n\tParsedECPointFormats,\n\tECPointFormatsExtension,\n} from './11_ec_point_formats';\nimport {\n\tSignatureAlgorithms,\n\tSignatureAlgorithmsExtension,\n} from './13_signature_algorithms';\nimport { ExtensionNames } from './types';\n\nexport const TLSExtensionsHandlers = {\n\tserver_name: ServerNameExtension,\n\tsignature_algorithms: SignatureAlgorithmsExtension,\n\tsupported_groups: SupportedGroupsExtension,\n\tec_point_formats: ECPointFormatsExtension,\n} as const;\n\nexport type SupportedTLSExtension = keyof typeof TLSExtensionsHandlers;\n\nexport type ParsedExtension =\n\t| {\n\t\t\ttype: 'server_name';\n\t\t\tdata: ServerNameList;\n\t\t\traw: Uint8Array;\n\t  }\n\t| {\n\t\t\ttype: 'signature_algorithms';\n\t\t\tdata: SignatureAlgorithms;\n\t\t\traw: Uint8Array;\n\t  }\n\t| {\n\t\t\ttype: 'ec_point_formats';\n\t\t\tdata: ParsedECPointFormats;\n\t\t\traw: Uint8Array;\n\t  }\n\t| {\n\t\t\ttype: 'supported_groups';\n\t\t\tdata: ParsedSupportedGroups;\n\t\t\traw: Uint8Array;\n\t  };\n\n/**\n * The extensions in a ClientHello message are encoded as follows:\n *\n * struct {\n *     ExtensionType extension_type;\n *     opaque extension_data<0..2^16-1>;\n * } Extension;\n *\n * The overall extensions structure is:\n *\n * Extension extensions<0..2^16-1>;\n *\n * This means:\n * •\tThere's a 2-byte length field for the entire extensions block.\n * •\tFollowed by zero or more individual extensions.\n *\n * Binary Data Layout\n *\n * +-----------------------------+\n * | Extension 1 Type (2 bytes)  |\n * +-----------------------------+\n * | Extension 1 Length (2 bytes)|\n * +-----------------------------+\n * | Extension 1 Data (variable) |\n * +-----------------------------+\n * | Extension 2 Type (2 bytes)  |\n * +-----------------------------+\n * | Extension 2 Length (2 bytes)|\n * +-----------------------------+\n * | Extension 2 Data (variable) |\n * +-----------------------------+\n * | ... (more extensions)       |\n * +-----------------------------+\n *\n * @param data\n * @returns\n */\nexport function parseClientHelloExtensions(data: Uint8Array) {\n\tconst reader = new ArrayBufferReader(data.buffer);\n\n\tconst parsed: ParsedExtension[] = [];\n\twhile (!reader.isFinished()) {\n\t\tconst initialOffset = reader.offset;\n\t\tconst extensionType = reader.readUint16();\n\t\tconst extensionTypeName = ExtensionNames[extensionType];\n\t\tconst extensionLength = reader.readUint16();\n\t\tconst extensionBytes = reader.readUint8Array(extensionLength);\n\n\t\tif (!(extensionTypeName in TLSExtensionsHandlers)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst handler =\n\t\t\tTLSExtensionsHandlers[\n\t\t\t\textensionTypeName as keyof typeof TLSExtensionsHandlers\n\t\t\t];\n\t\tparsed.push({\n\t\t\ttype: extensionTypeName,\n\t\t\tdata: handler.decodeFromClient(extensionBytes) as any,\n\t\t\traw: data.slice(initialOffset, initialOffset + 4 + extensionLength),\n\t\t});\n\t}\n\n\treturn parsed;\n}\n","import { concatArrayBuffers } from '../utils';\n\n/**\n * Implements the TLS 1.2 PRF using HMAC-SHA256.\n *\n * See https://datatracker.ietf.org/doc/html/rfc5246#section-5\n */\nexport async function tls12Prf(\n\tsecret: ArrayBuffer,\n\tlabel: ArrayBuffer,\n\tseed: ArrayBuffer,\n\toutputLength: number\n): Promise<ArrayBuffer> {\n\tconst seedBytes = concatArrayBuffers([label, seed]);\n\n\t// Import the secret as a CryptoKey\n\tconst hmacKey = await crypto.subtle.importKey(\n\t\t'raw',\n\t\tsecret,\n\t\t{ name: 'HMAC', hash: { name: 'SHA-256' } },\n\t\tfalse,\n\t\t['sign']\n\t);\n\n\tlet A = seedBytes; // Initialize A(0) = seedBytes\n\tconst resultBuffers: ArrayBuffer[] = [];\n\n\twhile (concatArrayBuffers(resultBuffers).byteLength < outputLength) {\n\t\t// A(i) = HMAC_hash(secret, A(i-1))\n\t\tA = await hmacSha256(hmacKey, A);\n\n\t\t// Compute HMAC_hash(secret, A(i) + seedBytes)\n\t\tconst hmacInput = concatArrayBuffers([A, seedBytes]);\n\t\tconst fragment = await hmacSha256(hmacKey, hmacInput);\n\n\t\tresultBuffers.push(fragment);\n\t}\n\n\t// Concatenate and trim the result to the desired length\n\tconst fullResult = concatArrayBuffers(resultBuffers);\n\treturn fullResult.slice(0, outputLength);\n}\n\nexport async function hmacSha256(\n\tkey: CryptoKey,\n\tdata: ArrayBuffer\n): Promise<ArrayBuffer> {\n\treturn await crypto.subtle.sign(\n\t\t{ name: 'HMAC', hash: 'SHA-256' },\n\t\tkey,\n\t\tdata\n\t);\n}\n","/**\n * TLS 1.2 Record layer types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-6.2\n */\n\nimport { ParsedExtension } from '../extensions/parse-extensions';\nimport { flipObject } from '../utils';\n\nexport const enum CompressionMethod {\n\tNull = 0,\n\tDeflate = 1,\n}\n\n/**\n * TLS 1.2 Record layer types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-6.2.1\n */\n\nexport interface TLSRecord {\n\ttype: ContentType; // 1 byte\n\tversion: ProtocolVersion; // 2 bytes\n\tlength: number; // 2 bytes\n\tfragment: Uint8Array; // variable length\n}\n\nexport interface ProtocolVersion {\n\tmajor: number;\n\tminor: number;\n}\n\nexport interface GenericStreamCipher {\n\tcontent: Uint8Array;\n\tMAC: Uint8Array;\n}\n\nexport interface GenericBlockCipher {\n\tIV: Uint8Array;\n\tblock_ciphered: BlockCiphered;\n}\n\nexport interface BlockCiphered {\n\tcontent: Uint8Array;\n\tMAC: Uint8Array;\n\tpadding: Uint8Array;\n\tpadding_length: number;\n}\n\nexport interface GenericAEADCipher {\n\tnonce_explicit: Uint8Array;\n\taead_encrypted: Uint8Array;\n}\n\n/**\n * TLS 1.2 Handshake types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4\n */\n\nexport type TLSMessage =\n\t| AlertMessage\n\t| HandshakeMessage<any>\n\t| ChangeCipherSpecMessage\n\t| ApplicationDataMessage;\n\nexport interface AlertMessage {\n\ttype: typeof ContentTypes.Alert;\n\tlevel: AlertLevel;\n\tdescription: AlertDescription;\n}\n\nexport const AlertLevels = {\n\tWarning: 1,\n\tFatal: 2,\n} as const;\nexport type AlertLevel = (typeof AlertLevels)[keyof typeof AlertLevels];\nexport const AlertLevelNames = flipObject(AlertLevels);\n\nexport const AlertDescriptions = {\n\tCloseNotify: 0,\n\tUnexpectedMessage: 10,\n\tBadRecordMac: 20,\n\tDecryptionFailed: 21,\n\tRecordOverflow: 22,\n\tDecompressionFailure: 30,\n\tHandshakeFailure: 40,\n\tNoCertificate: 41,\n\tBadCertificate: 42,\n\tUnsupportedCertificate: 43,\n\tCertificateRevoked: 44,\n\tCertificateExpired: 45,\n\tCertificateUnknown: 46,\n\tIllegalParameter: 47,\n\tUnknownCa: 48,\n\tAccessDenied: 49,\n\tDecodeError: 50,\n\tDecryptError: 51,\n\tExportRestriction: 60,\n\tProtocolVersion: 70,\n\tInsufficientSecurity: 71,\n\tInternalError: 80,\n\tUserCanceled: 90,\n\tNoRenegotiation: 100,\n\tUnsupportedExtension: 110,\n} as const;\nexport type AlertDescription =\n\t(typeof AlertDescriptions)[keyof typeof AlertDescriptions];\nexport const AlertDescriptionNames = flipObject(AlertDescriptions);\n\nexport interface ChangeCipherSpecMessage {\n\ttype: typeof ContentTypes.ChangeCipherSpec;\n\tbody: Uint8Array;\n}\n\nexport interface ApplicationDataMessage {\n\ttype: typeof ContentTypes.ApplicationData;\n\tbody: Uint8Array;\n}\n\nexport const ContentTypes = {\n\tChangeCipherSpec: 20,\n\tAlert: 21,\n\tHandshake: 22,\n\tApplicationData: 23,\n} as const;\nexport type ContentType = (typeof ContentTypes)[keyof typeof ContentTypes];\n\nexport const enum HandshakeType {\n\tHelloRequest = 0,\n\tClientHello = 1,\n\tServerHello = 2,\n\tCertificate = 11,\n\tServerKeyExchange = 12,\n\tCertificateRequest = 13,\n\tServerHelloDone = 14,\n\tCertificateVerify = 15,\n\tClientKeyExchange = 16,\n\n\tFinished = 20,\n}\n\nexport type HandshakeMessageBody =\n\t| HelloRequest\n\t| ClientHello\n\t| ServerHello\n\t| Certificate\n\t| ServerKeyExchange\n\t| CertificateRequest\n\t| ServerHelloDone\n\t| CertificateVerify\n\t| ClientKeyExchange\n\t| Finished;\n\nexport interface HandshakeMessage<Body extends HandshakeMessageBody> {\n\ttype: typeof ContentTypes.Handshake;\n\tmsg_type: HandshakeType; // 1 byte\n\tlength: number; // 2 bytes\n\t// Custom property to hold the raw body of the message\n\tbody: Body;\n}\n\n// Specific Handshake Message Types\nexport interface HelloRequest {} // Empty for TLS 1.2\n\n/**\n * 1 byte\n */\nexport type SessionId = Uint8Array;\nexport interface ClientHello {\n\tclient_version: Uint8Array; // 2 bytes\n\trandom: Uint8Array; // 32 bytes\n\tsession_id: SessionId;\n\tcipher_suites: string[];\n\tcompression_methods: Uint8Array;\n\textensions: ParsedExtension[];\n}\n\nexport interface ServerHello {\n\tserver_version: Uint8Array; // 2 bytes\n\trandom: Uint8Array; // 32 bytes\n\tsession_id: Uint8Array;\n\tcipher_suite: Uint8Array; // 2 bytes\n\tcompression_method: number;\n\textensions?: Uint8Array;\n}\n\nexport interface Certificate {\n\tcertificate_list: Uint8Array[];\n}\n\nexport interface ServerKeyExchange {\n\tparams: Uint8Array;\n\tsigned_params: Uint8Array;\n}\n\n/**\n * ECCurveType from\n * https://datatracker.ietf.org/doc/html/rfc4492#section-5.4\n */\nexport const ECCurveTypes = {\n\t/**\n\t * Indicates the elliptic curve domain parameters are\n\t * conveyed verbosely, and the underlying finite field is a prime\n\t * field.\n\t */\n\tExplicitPrime: 1,\n\t/**\n\t * Indicates the elliptic curve domain parameters are\n\t * conveyed verbosely, and the underlying finite field is a\n\t * characteristic-2 field.\n\t */\n\tExplicitChar2: 2,\n\t/**\n\t * Indicates that a named curve is used.  This option\n\t * SHOULD be used when applicable.\n\t */\n\tNamedCurve: 3,\n\t/**\n\t * Values 248 through 255 are reserved for private use.\n\t */\n};\n\n/**\n * Named elliptic curves from\n * https://datatracker.ietf.org/doc/html/rfc4492#section-5.1.1\n */\nexport const ECNamedCurves = {\n\tsect163k1: 1,\n\tsect163r1: 2,\n\tsect163r2: 3,\n\tsect193r1: 4,\n\tsect193r2: 5,\n\tsect233k1: 6,\n\tsect233r1: 7,\n\tsect239k1: 8,\n\tsect283k1: 9,\n\tsect283r1: 10,\n\tsect409k1: 11,\n\tsect409r1: 12,\n\tsecp256k1: 22,\n\tsecp256r1: 23,\n\tsecp384r1: 24,\n\tsecp521r1: 25,\n\tarbitrary_explicit_prime_curves: 0xff01,\n\tarbitrary_explicit_char2_curves: 0xff02,\n};\n\nexport interface CertificateRequest {\n\tcertificate_types: Uint8Array;\n\tsupported_signature_algorithms: Uint8Array;\n\tcertificate_authorities: Uint8Array;\n}\n\nexport interface ServerHelloDone {} // Empty for TLS 1.2\n\nexport interface CertificateVerify {\n\talgorithm: Uint8Array;\n\tsignature: Uint8Array;\n}\n\nexport interface ClientKeyExchange {\n\texchange_keys: Uint8Array;\n}\n\nexport interface Finished {\n\tverify_data: Uint8Array;\n}\n\nexport type SessionKeys = {\n\tmasterSecret: Uint8Array;\n\tclientWriteKey: CryptoKey;\n\tserverWriteKey: CryptoKey;\n\tclientIV: Uint8Array;\n\tserverIV: Uint8Array;\n};\n","import { ServerNameExtension } from '../extensions/0_server_name';\nimport { CipherSuitesNames } from '../cipher-suites';\nimport { CipherSuites } from '../cipher-suites';\nimport { SupportedGroupsExtension } from '../extensions/10_supported_groups';\nimport { ECPointFormatsExtension } from '../extensions/11_ec_point_formats';\nimport { parseClientHelloExtensions } from '../extensions/parse-extensions';\nimport {\n\tArrayBufferReader,\n\tas2Bytes,\n\tas3Bytes,\n\tas8Bytes,\n\tconcatUint8Arrays,\n} from '../utils';\nimport {\n\tHashAlgorithms,\n\tSignatureAlgorithms,\n\tSignatureAlgorithmsExtension,\n} from '../extensions/13_signature_algorithms';\nimport { tls12Prf } from './prf';\nimport {\n\tCompressionMethod,\n\tSessionKeys,\n\tHandshakeType,\n\tContentTypes,\n\tHandshakeMessage,\n\tClientHello,\n\tClientKeyExchange,\n\tFinished,\n\tApplicationDataMessage,\n\tAlertMessage,\n\tChangeCipherSpecMessage,\n\tTLSMessage,\n\tContentType,\n\tTLSRecord,\n\tAlertLevelNames,\n\tAlertDescriptionNames,\n\tHandshakeMessageBody,\n\tHelloRequest,\n\tECCurveTypes,\n\tECNamedCurves,\n} from './types';\n\nclass TLSConnectionClosed extends Error {}\nconst TLS_Version_1_2 = new Uint8Array([0x03, 0x03]);\n\n/**\n * Reuse the same ECDHE key pair for all connections to\n * save some CPU cycles. We can do this because this TLS\n * implementation is not meant to be secure.\n */\nconst generalEcdheKeyPair = crypto.subtle.generateKey(\n\t{\n\t\tname: 'ECDH',\n\t\tnamedCurve: 'P-256', // Use secp256r1 curve\n\t},\n\ttrue, // Extractable\n\t['deriveKey', 'deriveBits'] // Key usage\n);\n\n/**\n * This isomorphic class implements the server end of\n * the client <-> server TLS 1.2 connection. It has two ends:\n *\n * * Client end, that emits and accepts TLS encrypted data.\n * * Server end, that emits and accepts unencrypted data.\n *\n * The API consumer is responsible for connecting both ends\n * to the appropriate handlers.\n *\n * See https://datatracker.ietf.org/doc/html/rfc5246.\n *\n * ## Warning\n *\n * **WARNING** NEVER USE THIS CODE AS A SERVER-SIDE TLS HANDLER.\n *\n * This code is not secure. It is a minimal subset required\n * to decrypt the TLS traffic from a PHP-wasm worker. Yes,\n * it can speak TLS. No, it won't protect your data.\n *\n * ## Rationale\n *\n * This is useful for running PHP.wasm in web browsers.\n * Function calls such as `file_get_contents(\"https://w.org\")`\n * emit encrypted TLS traffic. With this class, you\n * can decrypt it, serve the requested data, and encrypt\n * the response before passing it back to the PHP.wasm\n * module.\n *\n * ## Implementation details\n *\n * TLS_1_2_Connection implements the minimal subset of TLS 1.2\n * required to exchange encrypted data with PHP.wasm:\n *\n * * TLS Handshake\n * * All TLS 1.2 record types, including messages spanning multiple\n *   records and empty records.\n * * Encryption and decryption of application data.\n * * Auto-chunking long data blobs before encrypting them to\n *   respect the AES-GCM record size limit.\n *\n * The logic is based on numerous RFCs:\n *\n * * RFC 5246: The TLS Protocol Version 1.2\n * * RFC 8446: TLS 1.3\n * * RFC 6066: TLS Extensions\n * * RFC 4492: Elliptic Curve Cryptography (ECC) Cipher Suites for TLS\n * * RFC 5288: AES Galois Counter Mode (GCM) Cipher Suites for TLS\n * * RFC 6070: PKCS #5: Password-Based Key Derivation Function 2 (PBKDF2) Test Vectors\n *\n * ... and a few others.\n *\n * ## Limitations\n *\n * * Multiple ChangeCipherSpec messages are not supported.\n * * Only uncompressed mode (compression method 0) is supported.\n * * Only the TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 cipher suite is\n *   supported, primarily because `crypto.subtle` supports AES-GCM.\n *   For AES-GCM details, see https://datatracker.ietf.org/doc/html/rfc5288.\n */\nexport class TLS_1_2_Connection {\n\t/**\n\t * Sequence number of the last received TLS  record.\n\t *\n\t * AES-GCM requires transmitting the sequence number\n\t * in the clear in the additional data to prevent a\n\t * potential attacker from re-transmitting the same\n\t * TLS record in a different context.\n\t */\n\tprivate receivedRecordSequenceNumber = 0;\n\n\t/**\n\t * Sequence number of the last sent TLS record.\n\t *\n\t * AES-GCM requires transmitting the sequence number\n\t * in the clear in the additional data to prevent a\n\t * potential attacker from re-transmitting the same\n\t * TLS record in a different context.\n\t */\n\tprivate sentRecordSequenceNumber = 0;\n\n\t/**\n\t * Encryption keys for this connection derived during\n\t * the TLS handshake.\n\t */\n\tprivate sessionKeys: SessionKeys | undefined;\n\n\t/**\n\t * Whether this connection have been closed.\n\t */\n\tprivate closed = false;\n\n\t/**\n\t * Bytes received from the client but not yet parsed\n\t * as TLS records.\n\t */\n\tprivate receivedBytesBuffer: Uint8Array = new Uint8Array();\n\n\t/**\n\t * TLS records received from the client but not yet\n\t * parsed as TLS messages.\n\t */\n\tprivate receivedTLSRecords: Array<TLSRecord> = [];\n\n\t/**\n\t * TLS messages can span multiple TLS records. This\n\t * map holds partial TLS messages that are still incomplete\n\t * after parsing one or more TLS records.\n\t */\n\tprivate partialTLSMessages: Partial<Record<ContentType, Uint8Array>> = {};\n\n\t/**\n\t * A log of all the exchanged TLS handshake messages.\n\t * This is required to build the Finished message and\n\t * verify the integrity of the handshake.\n\t */\n\tprivate handshakeMessages: Uint8Array[] = [];\n\n\t/**\n\t * Maximum chunk size supported by the cipher suite used\n\t * in this TLS implementation.\n\t */\n\tprivate MAX_CHUNK_SIZE = 1024 * 16;\n\n\t/**\n\t * The client end of the TLS connection.\n\t * This is where the WASM module can write and read the\n\t * encrypted data.\n\t */\n\tclientEnd = {\n\t\t// We don't need to chunk the encrypted data.\n\t\t// OpenSSL already done that for us.\n\t\tupstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t\tdownstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t};\n\n\tprivate clientDownstreamWriter =\n\t\tthis.clientEnd.downstream.writable.getWriter();\n\tprivate clientUpstreamReader = this.clientEnd.upstream.readable.getReader();\n\n\t/**\n\t * The server end of the TLS connection.\n\t * This is where the JavaScript handler can write and read the\n\t * unencrypted data.\n\t */\n\tserverEnd = {\n\t\tupstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t\t/**\n\t\t * Chunk the data before encrypting it. The\n\t\t * TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 cipher suite\n\t\t * only supports up to 16KB of data per record.\n\t\t *\n\t\t * This will spread some messages across multiple records,\n\t\t * but TLS supports it so that's fine.\n\t\t */\n\t\tdownstream: chunkStream(this.MAX_CHUNK_SIZE),\n\t};\n\n\tprivate serverUpstreamWriter = this.serverEnd.upstream.writable.getWriter();\n\n\tconstructor() {\n\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\n\t\tconst tlsConnection = this;\n\t\t// Whenever the \"server handler\" produces data, encrypt it\n\t\t// and send it back to the client.\n\t\tthis.serverEnd.downstream.readable\n\t\t\t.pipeTo(\n\t\t\t\tnew WritableStream({\n\t\t\t\t\tasync write(chunk) {\n\t\t\t\t\t\tawait tlsConnection.writeTLSRecord(\n\t\t\t\t\t\t\tContentTypes.ApplicationData,\n\t\t\t\t\t\t\tchunk\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\tasync abort(e) {\n\t\t\t\t\t\ttlsConnection.clientDownstreamWriter.releaseLock();\n\t\t\t\t\t\ttlsConnection.clientEnd.downstream.writable.abort(e);\n\t\t\t\t\t\ttlsConnection.close();\n\t\t\t\t\t},\n\t\t\t\t\tclose() {\n\t\t\t\t\t\ttlsConnection.close();\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t)\n\t\t\t.catch(() => {\n\t\t\t\t// Ignore failures arising from stream errors. The caller\n\t\t\t\t// should react to the readable stream erroring out.\n\t\t\t});\n\t}\n\n\t/**\n\t * Marks this connections as closed and closes all the associated\n\t * streams.\n\t */\n\tasync close() {\n\t\tif (this.closed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.closed = true;\n\t\ttry {\n\t\t\tawait this.clientDownstreamWriter.close();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientUpstreamReader.cancel();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.serverUpstreamWriter.close();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientEnd.upstream.readable.cancel();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientEnd.downstream.writable.close();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t}\n\n\t/**\n\t * TLS handshake as per RFC 5246.\n\t *\n\t * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4\n\t */\n\tasync TLSHandshake(\n\t\tcertificatePrivateKey: CryptoKey,\n\t\tcertificatesDER: Uint8Array[]\n\t): Promise<void> {\n\t\t// Step 1: Receive ClientHello\n\t\tconst clientHelloRecord = await this.readNextHandshakeMessage(\n\t\t\tHandshakeType.ClientHello\n\t\t);\n\t\tif (!clientHelloRecord.body.cipher_suites.length) {\n\t\t\tthrow new Error(\n\t\t\t\t'Client did not propose any supported cipher suites.'\n\t\t\t);\n\t\t}\n\n\t\t// Step 2: Choose hashing, encryption etc. and tell the\n\t\t//         client about our choices. Also share the certificate\n\t\t//         and the encryption keys.\n\t\tconst serverRandom = crypto.getRandomValues(new Uint8Array(32));\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.serverHello(\n\t\t\t\tclientHelloRecord.body,\n\t\t\t\tserverRandom,\n\t\t\t\tCompressionMethod.Null\n\t\t\t)\n\t\t);\n\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.certificate(certificatesDER)\n\t\t);\n\n\t\tconst ecdheKeyPair = await generalEcdheKeyPair;\n\t\tconst clientRandom = clientHelloRecord.body.random;\n\t\tconst serverKeyExchange = await MessageEncoder.ECDHEServerKeyExchange(\n\t\t\tclientRandom,\n\t\t\tserverRandom,\n\t\t\tecdheKeyPair,\n\t\t\tcertificatePrivateKey\n\t\t);\n\t\tawait this.writeTLSRecord(ContentTypes.Handshake, serverKeyExchange);\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.serverHelloDone()\n\t\t);\n\n\t\t// Step 3: Receive the client's response, encryption keys, and\n\t\t//         decrypt the first encrypted message.\n\t\tconst clientKeyExchangeRecord = await this.readNextHandshakeMessage(\n\t\t\tHandshakeType.ClientKeyExchange\n\t\t);\n\t\tawait this.readNextMessage(ContentTypes.ChangeCipherSpec);\n\n\t\tthis.sessionKeys = await this.deriveSessionKeys({\n\t\t\tclientRandom,\n\t\t\tserverRandom,\n\t\t\tserverPrivateKey: ecdheKeyPair.privateKey,\n\t\t\tclientPublicKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tclientKeyExchangeRecord.body.exchange_keys,\n\t\t\t\t{ name: 'ECDH', namedCurve: 'P-256' },\n\t\t\t\tfalse,\n\t\t\t\t[]\n\t\t\t),\n\t\t});\n\n\t\tawait this.readNextHandshakeMessage(HandshakeType.Finished);\n\n\t\t// We're not actually verifying the hash provided by client\n\t\t// as we're not concerned with the client's identity.\n\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.ChangeCipherSpec,\n\t\t\tMessageEncoder.changeCipherSpec()\n\t\t);\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tawait MessageEncoder.createFinishedMessage(\n\t\t\t\tthis.handshakeMessages,\n\t\t\t\tthis.sessionKeys!.masterSecret\n\t\t\t)\n\t\t);\n\t\t// Clean up the handshake messages as they are no longer needed.\n\t\tthis.handshakeMessages = [];\n\n\t\tthis.pollForClientMessages();\n\t}\n\n\t/**\n\t * Derives the session keys from the random values and the\n\t * pre-master secret – as per RFC 5246.\n\t */\n\tprivate async deriveSessionKeys({\n\t\tclientRandom,\n\t\tserverRandom,\n\t\tserverPrivateKey,\n\t\tclientPublicKey,\n\t}: {\n\t\tclientRandom: Uint8Array;\n\t\tserverRandom: Uint8Array;\n\t\tserverPrivateKey: CryptoKey;\n\t\tclientPublicKey: CryptoKey;\n\t}): Promise<SessionKeys> {\n\t\tconst preMasterSecret = await crypto.subtle.deriveBits(\n\t\t\t{\n\t\t\t\tname: 'ECDH',\n\t\t\t\tpublic: clientPublicKey,\n\t\t\t},\n\t\t\tserverPrivateKey,\n\t\t\t256 // Length of the derived secret (256 bits for P-256)\n\t\t);\n\n\t\tconst masterSecret = new Uint8Array(\n\t\t\tawait tls12Prf(\n\t\t\t\tpreMasterSecret,\n\t\t\t\tnew TextEncoder().encode('master secret'),\n\t\t\t\tconcatUint8Arrays([clientRandom, serverRandom]),\n\t\t\t\t48\n\t\t\t)\n\t\t);\n\n\t\tconst keyBlock = await tls12Prf(\n\t\t\tmasterSecret,\n\t\t\tnew TextEncoder().encode('key expansion'),\n\t\t\tconcatUint8Arrays([serverRandom, clientRandom]),\n\t\t\t// Client key, server key, client IV, server IV\n\t\t\t16 + 16 + 4 + 4\n\t\t);\n\n\t\tconst reader = new ArrayBufferReader(keyBlock);\n\t\tconst clientWriteKey = reader.readUint8Array(16);\n\t\tconst serverWriteKey = reader.readUint8Array(16);\n\t\tconst clientIV = reader.readUint8Array(4);\n\t\tconst serverIV = reader.readUint8Array(4);\n\n\t\treturn {\n\t\t\tmasterSecret,\n\t\t\tclientWriteKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tclientWriteKey,\n\t\t\t\t{ name: 'AES-GCM' },\n\t\t\t\tfalse,\n\t\t\t\t['encrypt', 'decrypt']\n\t\t\t),\n\t\t\tserverWriteKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tserverWriteKey,\n\t\t\t\t{ name: 'AES-GCM' },\n\t\t\t\tfalse,\n\t\t\t\t['encrypt', 'decrypt']\n\t\t\t),\n\t\t\tclientIV,\n\t\t\tserverIV,\n\t\t};\n\t}\n\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: HandshakeType.ClientHello\n\t): Promise<HandshakeMessage<ClientHello>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: HandshakeType.ClientKeyExchange\n\t): Promise<HandshakeMessage<ClientKeyExchange>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: HandshakeType.Finished\n\t): Promise<HandshakeMessage<Finished>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType:\n\t\t\t| HandshakeType.ClientHello\n\t\t\t| HandshakeType.ClientKeyExchange\n\t\t\t| HandshakeType.Finished\n\t): Promise<HandshakeMessage<any>> {\n\t\tconst message = await this.readNextMessage(ContentTypes.Handshake);\n\t\tif (message.msg_type !== messageType) {\n\t\t\tthrow new Error(`Expected ${messageType} message`);\n\t\t}\n\t\treturn message;\n\t}\n\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['Handshake']\n\t): Promise<HandshakeMessage<any>>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['ApplicationData']\n\t): Promise<ApplicationDataMessage>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['Alert']\n\t): Promise<AlertMessage>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['ChangeCipherSpec']\n\t): Promise<ChangeCipherSpecMessage>;\n\tprivate async readNextMessage<Message extends TLSMessage>(\n\t\trequestedType: ContentType\n\t): Promise<Message> {\n\t\tlet record: TLSRecord;\n\t\tlet accumulatedPayload: false | Uint8Array = false;\n\t\tdo {\n\t\t\trecord = await this.readNextTLSRecord(requestedType);\n\t\t\taccumulatedPayload = await this.accumulateUntilMessageIsComplete(\n\t\t\t\trecord\n\t\t\t);\n\t\t} while (accumulatedPayload === false);\n\n\t\tconst message = TLSDecoder.TLSMessage(\n\t\t\trecord.type,\n\t\t\taccumulatedPayload\n\t\t) as Message;\n\t\tif (record.type === ContentTypes.Handshake) {\n\t\t\tthis.handshakeMessages.push(record.fragment);\n\t\t}\n\t\treturn message;\n\t}\n\n\tprivate async readNextTLSRecord(\n\t\trequestedType: ContentType\n\t): Promise<TLSRecord> {\n\t\twhile (true) {\n\t\t\t// First, check if we have a complete record of the requested type.\n\t\t\tfor (let i = 0; i < this.receivedTLSRecords.length; i++) {\n\t\t\t\tconst record = this.receivedTLSRecords[i];\n\t\t\t\tif (record.type !== requestedType) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis.receivedTLSRecords.splice(i, 1);\n\t\t\t\treturn record;\n\t\t\t}\n\n\t\t\t// We don't have a complete record of the requested type yet.\n\t\t\t// Let's read the next TLS record, then.\n\t\t\tconst header = await this.pollBytes(5);\n\t\t\tconst length = (header[3] << 8) | header[4];\n\t\t\tconst type = header[0];\n\t\t\tconst fragment = await this.pollBytes(length);\n\t\t\tconst record = {\n\t\t\t\ttype,\n\t\t\t\tversion: {\n\t\t\t\t\tmajor: header[1],\n\t\t\t\t\tminor: header[2],\n\t\t\t\t},\n\t\t\t\tlength,\n\t\t\t\tfragment:\n\t\t\t\t\tthis.sessionKeys && type !== ContentTypes.ChangeCipherSpec\n\t\t\t\t\t\t? await this.decryptData(type, fragment)\n\t\t\t\t\t\t: fragment,\n\t\t\t} as TLSRecord;\n\n\t\t\tif (record.type === ContentTypes.Alert) {\n\t\t\t\tconst severity = AlertLevelNames[record.fragment[0]];\n\t\t\t\tconst description = AlertDescriptionNames[record.fragment[1]];\n\t\t\t\t/**\n\t\t\t\t * @TODO: Handle TLS warnings, e.g. this one:\n\t\t\t\t *\n\t\t\t\t * close_notify\n\t\t\t\t *     Either party may initiate a close by sending a close_notify alert.\n\t\t\t\t *     Any data received after a closure alert is ignored.\n\t\t\t\t *\n\t\t\t\t *     Unless some other fatal alert has been transmitted, each party is\n\t\t\t\t *     required to send a close_notify alert before closing the write side\n\t\t\t\t *     of the connection.  The other party MUST respond with a close_notify\n\t\t\t\t *     alert of its own and close down the connection immediately,\n\t\t\t\t *     discarding any pending writes.\n\t\t\t\t */\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`TLS non-warning alert received: ${severity} ${description}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.receivedTLSRecords.push(record);\n\t\t}\n\t}\n\n\t/**\n\t * Returns the requested number of bytes from the client.\n\t * Waits for the bytes to arrive if necessary.\n\t */\n\tprivate async pollBytes(length: number) {\n\t\twhile (this.receivedBytesBuffer.length < length) {\n\t\t\tconst { value, done } = await this.clientUpstreamReader.read();\n\t\t\tif (done) {\n\t\t\t\tawait this.close();\n\t\t\t\tthrow new TLSConnectionClosed('TLS connection closed');\n\t\t\t}\n\t\t\tthis.receivedBytesBuffer = concatUint8Arrays([\n\t\t\t\tthis.receivedBytesBuffer,\n\t\t\t\tvalue,\n\t\t\t]);\n\t\t\tif (this.receivedBytesBuffer.length >= length) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Patience is the key...\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t}\n\t\tconst requestedBytes = this.receivedBytesBuffer.slice(0, length);\n\t\tthis.receivedBytesBuffer = this.receivedBytesBuffer.slice(length);\n\t\treturn requestedBytes;\n\t}\n\n\t/**\n\t * Listens for all incoming messages and passes them to the\n\t * server handler.\n\t */\n\tprivate async pollForClientMessages() {\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst appData = await this.readNextMessage(\n\t\t\t\t\tContentTypes.ApplicationData\n\t\t\t\t);\n\t\t\t\tthis.serverUpstreamWriter.write(appData.body);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e instanceof TLSConnectionClosed) {\n\t\t\t\t// Connection closed, no more application data to emit.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts data in a TLS 1.2-compliant manner using\n\t * the AES-GCM algorithm.\n\t */\n\tprivate async decryptData(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<Uint8Array> {\n\t\tconst implicitIV = this.sessionKeys!.clientIV;\n\t\t// Part of the IV is randomly generated for each record\n\t\t// and prepended in its unencrypted form before the\n\t\t// ciphertext.\n\t\tconst explicitIV = payload.slice(0, 8);\n\t\tconst iv = new Uint8Array([...implicitIV, ...explicitIV]);\n\n\t\tconst decrypted = await crypto.subtle.decrypt(\n\t\t\t{\n\t\t\t\tname: 'AES-GCM',\n\t\t\t\tiv,\n\t\t\t\tadditionalData: new Uint8Array([\n\t\t\t\t\t...as8Bytes(this.receivedRecordSequenceNumber),\n\t\t\t\t\tcontentType,\n\t\t\t\t\t...TLS_Version_1_2,\n\t\t\t\t\t// Payload length without IV and tag\n\t\t\t\t\t...as2Bytes(payload.length - 8 - 16),\n\t\t\t\t]),\n\t\t\t\ttagLength: 128,\n\t\t\t},\n\t\t\tthis.sessionKeys!.clientWriteKey,\n\t\t\t// Payload without the explicit IV\n\t\t\tpayload.slice(8)\n\t\t);\n\t\t++this.receivedRecordSequenceNumber;\n\n\t\treturn new Uint8Array(decrypted);\n\t}\n\n\tprivate async accumulateUntilMessageIsComplete(\n\t\trecord: TLSRecord\n\t): Promise<false | Uint8Array> {\n\t\tthis.partialTLSMessages[record.type] = concatUint8Arrays([\n\t\t\tthis.partialTLSMessages[record.type] || new Uint8Array(),\n\t\t\trecord.fragment,\n\t\t]);\n\t\tconst message = this.partialTLSMessages[record.type]!;\n\t\tswitch (record.type) {\n\t\t\tcase ContentTypes.Handshake: {\n\t\t\t\t// We don't have the message header yet, let's wait for more data.\n\t\t\t\tif (message.length < 4) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tconst length = (message[1] << 8) | message[2];\n\t\t\t\tif (message.length < 3 + length) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase ContentTypes.Alert: {\n\t\t\t\tif (message.length < 2) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase ContentTypes.ChangeCipherSpec:\n\t\t\tcase ContentTypes.ApplicationData:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`TLS: Unsupported record type ${record.type}`);\n\t\t}\n\t\tdelete this.partialTLSMessages[record.type];\n\t\treturn message;\n\t}\n\n\t/**\n\t * Passes a TLS record to the client.\n\t *\n\t * Accepts unencrypted data and ensures it gets encrypted\n\t * if needed before sending it to the client. The encryption\n\t * only kicks in after the handshake is complete.\n\t */\n\tprivate async writeTLSRecord(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<void> {\n\t\tif (contentType === ContentTypes.Handshake) {\n\t\t\tthis.handshakeMessages.push(payload);\n\t\t}\n\t\tif (this.sessionKeys && contentType !== ContentTypes.ChangeCipherSpec) {\n\t\t\tpayload = await this.encryptData(contentType, payload);\n\t\t}\n\n\t\tconst version = TLS_Version_1_2;\n\t\tconst length = payload.length;\n\t\tconst header = new Uint8Array(5);\n\t\theader[0] = contentType;\n\t\theader[1] = version[0];\n\t\theader[2] = version[1];\n\t\theader[3] = (length >> 8) & 0xff;\n\t\theader[4] = length & 0xff;\n\n\t\tconst record = concatUint8Arrays([header, payload]);\n\t\tthis.clientDownstreamWriter.write(record);\n\t}\n\n\t/**\n\t * Encrypts data in a TLS 1.2-compliant manner using\n\t * the AES-GCM algorithm.\n\t */\n\tprivate async encryptData(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<Uint8Array> {\n\t\tconst implicitIV = this.sessionKeys!.serverIV;\n\t\t// Part of the IV is randomly generated for each record\n\t\t// and prepended in its unencrypted form before the\n\t\t// ciphertext.\n\t\tconst explicitIV = crypto.getRandomValues(new Uint8Array(8));\n\t\tconst iv = new Uint8Array([...implicitIV, ...explicitIV]);\n\n\t\tconst additionalData = new Uint8Array([\n\t\t\t...as8Bytes(this.sentRecordSequenceNumber),\n\t\t\tcontentType,\n\t\t\t...TLS_Version_1_2,\n\t\t\t// Payload length without IV and tag\n\t\t\t...as2Bytes(payload.length),\n\t\t]);\n\t\tconst ciphertextWithTag = await crypto.subtle.encrypt(\n\t\t\t{\n\t\t\t\tname: 'AES-GCM',\n\t\t\t\tiv,\n\t\t\t\tadditionalData,\n\t\t\t\ttagLength: 128,\n\t\t\t},\n\t\t\tthis.sessionKeys!.serverWriteKey,\n\t\t\tpayload\n\t\t);\n\t\t++this.sentRecordSequenceNumber;\n\n\t\tconst encrypted = concatUint8Arrays([\n\t\t\texplicitIV,\n\t\t\tnew Uint8Array(ciphertextWithTag),\n\t\t]);\n\n\t\treturn encrypted;\n\t}\n}\n\nclass TLSDecoder {\n\tstatic TLSMessage(\n\t\ttype: ContentType,\n\t\taccumulatedPayload: Uint8Array\n\t): TLSMessage {\n\t\tswitch (type) {\n\t\t\tcase ContentTypes.Handshake: {\n\t\t\t\treturn TLSDecoder.clientHandshake(accumulatedPayload);\n\t\t\t}\n\t\t\tcase ContentTypes.Alert: {\n\t\t\t\treturn TLSDecoder.alert(accumulatedPayload);\n\t\t\t}\n\t\t\tcase ContentTypes.ChangeCipherSpec: {\n\t\t\t\treturn TLSDecoder.changeCipherSpec();\n\t\t\t}\n\t\t\tcase ContentTypes.ApplicationData: {\n\t\t\t\treturn TLSDecoder.applicationData(accumulatedPayload);\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`TLS: Unsupported TLS record type ${type}`);\n\t\t}\n\t}\n\n\t/**\n\t * Parses the cipher suites from the server hello message.\n\t *\n\t * The cipher suites are encoded as a list of 2-byte values.\n\t *\n\t * Binary layout:\n\t *\n\t * +----------------------------+\n\t * | Cipher Suites Length       |  2 bytes\n\t * +----------------------------+\n\t * | Cipher Suite 1             |  2 bytes\n\t * +----------------------------+\n\t * | Cipher Suite 2             |  2 bytes\n\t * +----------------------------+\n\t * | ...                        |\n\t * +----------------------------+\n\t * | Cipher Suite n             |  2 bytes\n\t * +----------------------------+\n\t *\n\t * The full list of supported cipher suites values is available at:\n\t *\n\t * https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-4\n\t */\n\tstatic parseCipherSuites(buffer: ArrayBuffer): string[] {\n\t\tconst reader = new ArrayBufferReader(buffer);\n\t\t// Skip the length of the cipher suites\n\t\treader.readUint16();\n\n\t\tconst cipherSuites = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst suite = reader.readUint16();\n\t\t\tif (!(suite in CipherSuitesNames)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tcipherSuites.push(CipherSuitesNames[suite]);\n\t\t}\n\t\treturn cipherSuites;\n\t}\n\n\tstatic applicationData(message: Uint8Array): ApplicationDataMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.ApplicationData,\n\t\t\tbody: message,\n\t\t};\n\t}\n\n\tstatic changeCipherSpec(): ChangeCipherSpecMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.ChangeCipherSpec,\n\t\t\tbody: new Uint8Array(),\n\t\t};\n\t}\n\n\tstatic alert(message: Uint8Array): AlertMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.Alert,\n\t\t\tlevel: AlertLevelNames[message[0]],\n\t\t\tdescription: AlertDescriptionNames[message[1]],\n\t\t};\n\t}\n\n\tstatic clientHandshake<T extends HandshakeMessageBody>(\n\t\tmessage: Uint8Array\n\t): HandshakeMessage<T> {\n\t\tconst msg_type = message[0];\n\t\tconst length = (message[1] << 16) | (message[2] << 8) | message[3];\n\t\tconst bodyBytes = message.slice(4);\n\t\tlet body: HandshakeMessageBody | undefined = undefined;\n\t\tswitch (msg_type) {\n\t\t\tcase HandshakeType.HelloRequest:\n\t\t\t\tbody = TLSDecoder.clientHelloRequestPayload();\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.ClientHello:\n\t\t\t\tbody = TLSDecoder.clientHelloPayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.ClientKeyExchange:\n\t\t\t\tbody = TLSDecoder.clientKeyExchangePayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.Finished:\n\t\t\t\tbody = TLSDecoder.clientFinishedPayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Invalid handshake type ${msg_type}`);\n\t\t}\n\t\treturn {\n\t\t\ttype: ContentTypes.Handshake,\n\t\t\tmsg_type,\n\t\t\tlength,\n\t\t\tbody: body as T,\n\t\t};\n\t}\n\n\tstatic clientHelloRequestPayload(): HelloRequest {\n\t\treturn {};\n\t}\n\n\t/**\n\t *\tOffset  Size    Field\n\t *\t(bytes) (bytes)\n\t *\t+------+------+---------------------------+\n\t *\t| 0000 |  1   | Handshake Type (1 = ClientHello)\n\t *\t+------+------+---------------------------+\n\t *\t| 0001 |  3   | Length of ClientHello\n\t *\t+------+------+---------------------------+\n\t *\t| 0004 |  2   | Protocol Version\n\t *\t+------+------+---------------------------+\n\t *\t| 0006 |  32  | Client Random\n\t *\t|      |      | (4 bytes timestamp +\n\t *\t|      |      |  28 bytes random)\n\t *\t+------+------+---------------------------+\n\t *\t| 0038 |  1   | Session ID Length\n\t *\t+------+------+---------------------------+\n\t *\t| 0039 |  0+  | Session ID (variable)\n\t *\t|      |      | (0-32 bytes)\n\t *\t+------+------+---------------------------+\n\t *\t| 003A*|  2   | Cipher Suites Length\n\t *\t+------+------+---------------------------+\n\t *\t| 003C*|  2+  | Cipher Suites\n\t *\t|      |      | (2 bytes each)\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  1   | Compression Methods Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  1+  | Compression Methods\n\t *\t|      |      | (1 byte each)\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extensions Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extension Type\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extension Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  v   | Extension Data\n\t *\t+------+------+---------------------------+\n\t *\t|      |      | (Additional extensions...)\n\t *\t+------+------+---------------------------+\n\t */\n\tstatic clientHelloPayload(data: Uint8Array): ClientHello {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\tconst buff: Partial<ClientHello> = {\n\t\t\tclient_version: reader.readUint8Array(2),\n\t\t\t/**\n\t\t\t * Technically this consists of a GMT timestamp\n\t\t\t * and 28 random bytes, but we don't need to\n\t\t\t * parse this further.\n\t\t\t */\n\t\t\trandom: reader.readUint8Array(32),\n\t\t};\n\t\tconst sessionIdLength = reader.readUint8();\n\t\tbuff.session_id = reader.readUint8Array(sessionIdLength);\n\n\t\tconst cipherSuitesLength = reader.readUint16();\n\t\tbuff.cipher_suites = TLSDecoder.parseCipherSuites(\n\t\t\treader.readUint8Array(cipherSuitesLength).buffer\n\t\t);\n\n\t\tconst compressionMethodsLength = reader.readUint8();\n\t\tbuff.compression_methods = reader.readUint8Array(\n\t\t\tcompressionMethodsLength\n\t\t);\n\n\t\tconst extensionsLength = reader.readUint16();\n\t\tbuff.extensions = parseClientHelloExtensions(\n\t\t\treader.readUint8Array(extensionsLength)\n\t\t);\n\t\treturn buff as ClientHello;\n\t}\n\n\t/**\n\t * Binary layout:\n\t *\n\t *\t+------------------------------------+\n\t *\t| ECDH Client Public Key Length [1B] |\n\t *\t+------------------------------------+\n\t *\t| ECDH Client Public Key   [variable]|\n\t *\t+------------------------------------+\n\t */\n\tstatic clientKeyExchangePayload(data: Uint8Array): ClientKeyExchange {\n\t\treturn {\n\t\t\t// Skip the first byte, which is the length of the public key\n\t\t\texchange_keys: data.slice(1, data.length),\n\t\t};\n\t}\n\n\tstatic clientFinishedPayload(data: Uint8Array): Finished {\n\t\treturn {\n\t\t\tverify_data: data,\n\t\t};\n\t}\n}\n\n/**\n * Creates a stream that emits chunks not larger than\n * the specified size.\n */\nfunction chunkStream(chunkSize: number) {\n\treturn new TransformStream({\n\t\ttransform(chunk, controller) {\n\t\t\twhile (chunk.length > 0) {\n\t\t\t\tcontroller.enqueue(chunk.slice(0, chunkSize));\n\t\t\t\tchunk = chunk.slice(chunkSize);\n\t\t\t}\n\t\t},\n\t});\n}\n\nclass MessageEncoder {\n\tstatic certificate(certificatesDER: ArrayBuffer[]): Uint8Array {\n\t\tconst certsBodies: Uint8Array[] = [];\n\t\tfor (const cert of certificatesDER) {\n\t\t\tcertsBodies.push(as3Bytes(cert.byteLength));\n\t\t\tcertsBodies.push(new Uint8Array(cert));\n\t\t}\n\t\tconst certsBody = concatUint8Arrays(certsBodies);\n\t\tconst body = new Uint8Array([\n\t\t\t...as3Bytes(certsBody.byteLength),\n\t\t\t...certsBody,\n\t\t]);\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.Certificate,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\t/*\n\t * Byte layout of the ServerKeyExchange message:\n\t *\n\t * +-----------------------------------+\n\t * |    ServerKeyExchange Message      |\n\t * +-----------------------------------+\n\t * | Handshake type (1 byte)           |\n\t * +-----------------------------------+\n\t * | Length (3 bytes)                  |\n\t * +-----------------------------------+\n\t * | Curve Type (1 byte)               |\n\t * +-----------------------------------+\n\t * | Named Curve (2 bytes)             |\n\t * +-----------------------------------+\n\t * | EC Point Format (1 byte)          |\n\t * +-----------------------------------+\n\t * | Public Key Length (1 byte)        |\n\t * +-----------------------------------+\n\t * | Public Key (variable)             |\n\t * +-----------------------------------+\n\t * | Signature Algorithm (2 bytes)     |\n\t * +-----------------------------------+\n\t * | Signature Length (2 bytes)        |\n\t * +-----------------------------------+\n\t * | Signature (variable)              |\n\t * +-----------------------------------+\n\t *\n\t * @param clientRandom - 32 bytes from ClientHello\n\t * @param serverRandom - 32 bytes from ServerHello\n\t * @param ecdheKeyPair - ECDHE key pair\n\t * @param rsaPrivateKey - RSA private key for signing\n\t * @returns\n\t */\n\tstatic async ECDHEServerKeyExchange(\n\t\tclientRandom: Uint8Array,\n\t\tserverRandom: Uint8Array,\n\t\tecdheKeyPair: CryptoKeyPair,\n\t\trsaPrivateKey: CryptoKey\n\t): Promise<Uint8Array> {\n\t\t// 65 bytes (04 followed by x and y coordinates)\n\t\tconst publicKey = new Uint8Array(\n\t\t\tawait crypto.subtle.exportKey('raw', ecdheKeyPair.publicKey)\n\t\t);\n\n\t\t/*\n\t\t * The ServerKeyExchange message is extended as follows.\n\t\t *\n\t\t * select (KeyExchangeAlgorithm) {\n\t\t *     case ec_diffie_hellman:\n\t\t *         ServerECDHParams    params;\n\t\t *         Signature           signed_params;\n\t\t * } ServerKeyExchange;\n\t\t *\n\t\t * struct {\n\t\t *   ECCurveType     curve_type;\n\t\t *   NamedCurve      namedcurve;\n\t\t *   ECPoint         public;\n\t\t * } ServerECDHParams;\n\t\t */\n\t\tconst params = new Uint8Array([\n\t\t\t// Curve type (1 byte)\n\t\t\tECCurveTypes.NamedCurve,\n\t\t\t// Curve name (2 bytes)\n\t\t\t...as2Bytes(ECNamedCurves.secp256r1),\n\n\t\t\t// Public key length (1 byte)\n\t\t\tpublicKey.byteLength,\n\n\t\t\t// Public key (65 bytes, uncompressed format)\n\t\t\t...publicKey,\n\t\t]);\n\n\t\t/**\n\t\t * signed_params:\n\t\t *    A hash of the params, with the signature appropriate to that hash\n\t\t *    applied.  The private key corresponding to the certified public key\n\t\t *    in the server's Certificate message is used for signing.\n\t\t *\n\t\t *    Signature = encrypt(SHA(\n\t\t *       ClientHello.random + ServerHello.random + ServerECDHParams\n\t\t *    ));\n\t\t */\n\t\tconst signedParams = await crypto.subtle.sign(\n\t\t\t{\n\t\t\t\tname: 'RSASSA-PKCS1-v1_5',\n\t\t\t\thash: 'SHA-256',\n\t\t\t},\n\t\t\trsaPrivateKey,\n\t\t\tnew Uint8Array([...clientRandom, ...serverRandom, ...params])\n\t\t);\n\t\tconst signatureBytes = new Uint8Array(signedParams);\n\n\t\t/**\n\t\t * SignatureAlgorithm is \"rsa\" for the ECDHE_RSA key exchange\n\t\t * These cases are defined in TLS [RFC2246].\n\t\t */\n\t\tconst signatureAlgorithm = new Uint8Array([\n\t\t\tHashAlgorithms.sha256,\n\t\t\tSignatureAlgorithms.rsa,\n\t\t]);\n\n\t\t// Step 6: Construct the complete Server Key Exchange message\n\t\tconst body = new Uint8Array([\n\t\t\t...params,\n\t\t\t...signatureAlgorithm,\n\t\t\t...as2Bytes(signatureBytes.length),\n\t\t\t...signatureBytes,\n\t\t]);\n\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.ServerKeyExchange,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\t/**\n\t * +------------------------------------+\n\t * | Content Type (Handshake)     [1B]  |\n\t * | 0x16                               |\n\t * +------------------------------------+\n\t * | Version (TLS 1.2)            [2B]  |\n\t * | 0x03 0x03                          |\n\t * +------------------------------------+\n\t * | Length                       [2B]  |\n\t * +------------------------------------+\n\t * | Handshake Type (ServerHello) [1B]  |\n\t * | 0x02                               |\n\t * +------------------------------------+\n\t * | Handshake Length             [3B]  |\n\t * +------------------------------------+\n\t * | Server Version               [2B]  |\n\t * +------------------------------------+\n\t * | Server Random               [32B]  |\n\t * +------------------------------------+\n\t * | Session ID Length            [1B]  |\n\t * +------------------------------------+\n\t * | Session ID             [0-32B]     |\n\t * +------------------------------------+\n\t * | Cipher Suite                 [2B]  |\n\t * +------------------------------------+\n\t * | Compression Method           [1B]  |\n\t * +------------------------------------+\n\t * | Extensions Length            [2B]  |\n\t * +------------------------------------+\n\t * | Extension: ec_point_formats        |\n\t * |   Type (0x00 0x0B)           [2B]  |\n\t * |   Length                     [2B]  |\n\t * |   EC Point Formats Length    [1B]  |\n\t * |   EC Point Format            [1B]  |\n\t * +------------------------------------+\n\t * | Other Extensions...                |\n\t * +------------------------------------+\n\t */\n\tstatic serverHello(\n\t\tclientHello: ClientHello,\n\t\tserverRandom: Uint8Array,\n\t\tcompressionAlgorithm: number\n\t): Uint8Array {\n\t\tconst extensionsParts: Uint8Array[] = clientHello.extensions\n\t\t\t.map((extension) => {\n\t\t\t\tswitch (extension['type']) {\n\t\t\t\t\tcase 'server_name':\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The server SHALL include an extension of type \"server_name\" in the\n\t\t\t\t\t\t * (extended) server hello.  The \"extension_data\" field of this extension\n\t\t\t\t\t\t * SHALL be empty.\n\t\t\t\t\t\t *\n\t\t\t\t\t\t * Source: dfile:///Users/cloudnik/Library/Application%20Support/Dash/User%20Contributed/RFCs/RFCs.docset/Contents/Resources/Documents/rfc6066.html#section-3\n\t\t\t\t\t\t */\n\t\t\t\t\t\treturn ServerNameExtension.encodeForClient();\n\t\t\t\t\tcase 'supported_groups':\n\t\t\t\t\t\treturn SupportedGroupsExtension.encodeForClient(\n\t\t\t\t\t\t\t'secp256r1'\n\t\t\t\t\t\t);\n\t\t\t\t\tcase 'ec_point_formats':\n\t\t\t\t\t\treturn ECPointFormatsExtension.encodeForClient(\n\t\t\t\t\t\t\t'uncompressed'\n\t\t\t\t\t\t);\n\t\t\t\t\tcase 'signature_algorithms':\n\t\t\t\t\t\treturn SignatureAlgorithmsExtension.encodeforClient(\n\t\t\t\t\t\t\t'sha256',\n\t\t\t\t\t\t\t'rsa'\n\t\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t})\n\t\t\t.filter((x): x is Uint8Array => x !== undefined);\n\t\tconst extensions = concatUint8Arrays(extensionsParts);\n\n\t\tconst body = new Uint8Array([\n\t\t\t// Version field – 0x03, 0x03 means TLS 1.2\n\t\t\t...TLS_Version_1_2,\n\n\t\t\t...serverRandom,\n\n\t\t\tclientHello.session_id.length,\n\t\t\t...clientHello.session_id,\n\n\t\t\t...as2Bytes(CipherSuites.TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256),\n\n\t\t\tcompressionAlgorithm,\n\n\t\t\t// Extensions length (2 bytes)\n\t\t\t...as2Bytes(extensions.length),\n\n\t\t\t...extensions,\n\t\t]);\n\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.ServerHello,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\tstatic serverHelloDone(): Uint8Array {\n\t\treturn new Uint8Array([HandshakeType.ServerHelloDone, ...as3Bytes(0)]);\n\t}\n\n\t/**\n\t * Server finished message.\n\t * The structure is defined in:\n\t * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.9\n\t *\n\t * struct {\n\t *     opaque verify_data[verify_data_length];\n\t * } Finished;\n\t *\n\t * verify_data\n\t *    PRF(master_secret, finished_label, Hash(handshake_messages))\n\t *       [0..verify_data_length-1];\n\t *\n\t * finished_label\n\t *    For Finished messages sent by the client, the string\n\t *    \"client finished\".  For Finished messages sent by the server,\n\t *    the string \"server finished\".\n\t */\n\tstatic async createFinishedMessage(\n\t\thandshakeMessages: Uint8Array[],\n\t\tmasterSecret: ArrayBuffer\n\t): Promise<Uint8Array> {\n\t\t// Step 1: Compute the hash of the handshake messages\n\t\tconst handshakeHash = await crypto.subtle.digest(\n\t\t\t'SHA-256',\n\t\t\tconcatUint8Arrays(handshakeMessages)\n\t\t);\n\n\t\t// Step 2: Compute the verify_data using the PRF\n\t\tconst verifyData = new Uint8Array(\n\t\t\tawait tls12Prf(\n\t\t\t\tmasterSecret,\n\t\t\t\tnew TextEncoder().encode('server finished'),\n\t\t\t\thandshakeHash,\n\t\t\t\t// verify_data length. TLS 1.2 specifies 12 bytes for verify_data\n\t\t\t\t12\n\t\t\t)\n\t\t);\n\n\t\t// Step 3: Construct the Finished message\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.Finished,\n\t\t\t...as3Bytes(verifyData.length),\n\t\t\t...verifyData,\n\t\t]);\n\t}\n\n\tstatic changeCipherSpec(): Uint8Array {\n\t\treturn new Uint8Array([0x01]);\n\t}\n}\n","import { concatUint8Arrays } from './utils';\n\n/**\n * Generates an X.509 certificate from the given description.\n *\n * If the issuer key pair is provided, the certificate will be signed\n * using the provided issuer's private key. Otherwise, the certificate\n * will be self-signed.\n *\n * The code below is underdocumented. The following links may provide\n * more clarity about X.509, ASN.1, DER, PEM, and other data formats\n * this module encodes:\n *\n * * https://letsencrypt.org/docs/a-warm-welcome-to-asn1-and-der/\n * * https://dev.to/wayofthepie/structure-of-an-ssl-x-509-certificate-16b\n * * https://www.oss.com/asn1/resources/asn1-made-simple/asn1-quick-reference/asn1-tags.html\n */\nexport function generateCertificate(\n\tdescription: TBSCertificateDescription,\n\tissuerKeyPair?: CryptoKeyPair\n): Promise<GeneratedCertificate> {\n\treturn CertificateGenerator.generateCertificate(description, issuerKeyPair);\n}\n\nexport function certificateToPEM(certificate: Uint8Array): string {\n\treturn `-----BEGIN CERTIFICATE-----\\n${formatPEM(\n\t\tencodeUint8ArrayAsBase64(certificate.buffer)\n\t)}\\n-----END CERTIFICATE-----`;\n}\n\nexport async function privateKeyToPEM(privateKey: CryptoKey): Promise<string> {\n\tconst pkcs8 = await crypto.subtle.exportKey('pkcs8', privateKey);\n\treturn `-----BEGIN PRIVATE KEY-----\\n${formatPEM(\n\t\tencodeUint8ArrayAsBase64(pkcs8)\n\t)}\\n-----END PRIVATE KEY-----`;\n}\n\nclass CertificateGenerator {\n\tstatic async generateCertificate(\n\t\ttbsDescription: TBSCertificateDescription,\n\t\tissuerKeyPair?: CryptoKeyPair\n\t) {\n\t\tconst subjectKeyPair = await crypto.subtle.generateKey(\n\t\t\t{\n\t\t\t\tname: 'RSASSA-PKCS1-v1_5',\n\t\t\t\thash: 'SHA-256',\n\t\t\t\tmodulusLength: 2048,\n\t\t\t\tpublicExponent: new Uint8Array([0x01, 0x00, 0x01]),\n\t\t\t},\n\t\t\ttrue, // extractable\n\t\t\t['sign', 'verify']\n\t\t);\n\t\tconst tbsCertificate = await this.signingRequest(\n\t\t\ttbsDescription,\n\t\t\tsubjectKeyPair.publicKey\n\t\t);\n\t\tconst certificate = await this.sign(\n\t\t\ttbsCertificate,\n\t\t\tissuerKeyPair?.privateKey ?? subjectKeyPair.privateKey\n\t\t);\n\t\treturn {\n\t\t\tkeyPair: subjectKeyPair,\n\t\t\tcertificate,\n\t\t\ttbsCertificate,\n\t\t\ttbsDescription,\n\t\t};\n\t}\n\n\tstatic async sign(\n\t\ttbsCertificate: TBSCertificate,\n\t\tprivateKey: CryptoKey\n\t): Promise<Uint8Array> {\n\t\t// Step 3: Sign the TBSCertificate\n\t\tconst signature = await crypto.subtle.sign(\n\t\t\t{\n\t\t\t\tname: 'RSASSA-PKCS1-v1_5',\n\t\t\t\thash: 'SHA-256',\n\t\t\t},\n\t\t\tprivateKey,\n\t\t\ttbsCertificate.buffer\n\t\t);\n\n\t\t// Step 4: Build the final Certificate sequence\n\t\tconst certificate = ASN1Encoder.sequence([\n\t\t\tnew Uint8Array(tbsCertificate.buffer),\n\t\t\tthis.signatureAlgorithm('sha256WithRSAEncryption'),\n\t\t\tASN1Encoder.bitString(new Uint8Array(signature)),\n\t\t]);\n\t\treturn certificate;\n\t}\n\n\tstatic async signingRequest(\n\t\tdescription: TBSCertificateDescription,\n\t\tsubjectPublicKey: CryptoKey\n\t): Promise<TBSCertificate> {\n\t\tconst extensions: Uint8Array[] = [];\n\t\tif (description.keyUsage) {\n\t\t\textensions.push(this.keyUsage(description.keyUsage));\n\t\t}\n\t\tif (description.extKeyUsage) {\n\t\t\textensions.push(this.extKeyUsage(description.extKeyUsage));\n\t\t}\n\t\tif (description.subjectAltNames) {\n\t\t\textensions.push(this.subjectAltName(description.subjectAltNames));\n\t\t}\n\t\tif (description.nsCertType) {\n\t\t\textensions.push(this.nsCertType(description.nsCertType));\n\t\t}\n\t\tif (description.basicConstraints) {\n\t\t\textensions.push(\n\t\t\t\tthis.basicConstraints(description.basicConstraints)\n\t\t\t);\n\t\t}\n\t\treturn ASN1Encoder.sequence([\n\t\t\tthis.version(description.version),\n\t\t\tthis.serialNumber(description.serialNumber),\n\t\t\tthis.signatureAlgorithm(description.signatureAlgorithm),\n\t\t\tthis.distinguishedName(description.issuer ?? description.subject),\n\t\t\tthis.validity(description.validity),\n\t\t\tthis.distinguishedName(description.subject),\n\t\t\tawait this.subjectPublicKeyInfo(subjectPublicKey),\n\t\t\tthis.extensions(extensions),\n\t\t]);\n\t}\n\n\tprivate static version(version = 0x02) {\n\t\t// [0] EXPLICIT Version: 2 (v3)\n\t\treturn ASN1Encoder.ASN1(\n\t\t\t0xa0,\n\t\t\tASN1Encoder.integer(new Uint8Array([version]))\n\t\t);\n\t}\n\n\tprivate static serialNumber(\n\t\tserialNumber = crypto.getRandomValues(new Uint8Array(4))\n\t) {\n\t\treturn ASN1Encoder.integer(serialNumber);\n\t}\n\n\tprivate static signatureAlgorithm(\n\t\talgorithm: OIDName = 'sha256WithRSAEncryption'\n\t) {\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.objectIdentifier(oidByName(algorithm)),\n\t\t\tASN1Encoder.null(),\n\t\t]);\n\t}\n\n\tprivate static async subjectPublicKeyInfo(publicKey: CryptoKey) {\n\t\t// ExportKey already returns data in ASN.1 DER format, we don't\n\t\t// need to wrap it in a sequence agin.\n\t\treturn new Uint8Array(await crypto.subtle.exportKey('spki', publicKey));\n\t}\n\n\tprivate static extensions(extensions: Uint8Array[]) {\n\t\treturn ASN1Encoder.ASN1(0xa3, ASN1Encoder.sequence(extensions));\n\t}\n\n\tprivate static distinguishedName(nameInfo: DistinguishedName) {\n\t\tconst values = [];\n\t\tfor (const [oidName, value] of Object.entries(nameInfo)) {\n\t\t\tconst entry = [\n\t\t\t\tASN1Encoder.objectIdentifier(oidByName(oidName as OIDName)),\n\t\t\t];\n\t\t\tswitch (oidName) {\n\t\t\t\tcase 'countryName':\n\t\t\t\t\tentry.push(ASN1Encoder.printableString(value));\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tentry.push(ASN1Encoder.utf8String(value));\n\t\t\t}\n\t\t\tvalues.push(ASN1Encoder.set([ASN1Encoder.sequence(entry)]));\n\t\t}\n\t\treturn ASN1Encoder.sequence(values);\n\t}\n\n\tprivate static validity(validity?: Validity) {\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.ASN1(\n\t\t\t\tASN1Tags.UTCTime,\n\t\t\t\tnew TextEncoder().encode(\n\t\t\t\t\tformatDateASN1(validity?.notBefore ?? new Date())\n\t\t\t\t)\n\t\t\t),\n\t\t\tASN1Encoder.ASN1(\n\t\t\t\tASN1Tags.UTCTime,\n\t\t\t\tnew TextEncoder().encode(\n\t\t\t\t\tformatDateASN1(\n\t\t\t\t\t\tvalidity?.notAfter ?? addYears(new Date(), 10)\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t),\n\t\t]);\n\t}\n\n\tprivate static basicConstraints({\n\t\tca = true,\n\t\tpathLenConstraint = undefined,\n\t}: BasicConstraints) {\n\t\tconst sequence = [ASN1Encoder.boolean(ca)];\n\t\tif (pathLenConstraint !== undefined) {\n\t\t\tsequence.push(\n\t\t\t\tASN1Encoder.integer(new Uint8Array([pathLenConstraint]))\n\t\t\t);\n\t\t}\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.objectIdentifier(oidByName('basicConstraints')),\n\t\t\tASN1Encoder.octetString(ASN1Encoder.sequence(sequence)),\n\t\t]);\n\t}\n\n\tprivate static keyUsage(keyUsage?: KeyUsage) {\n\t\tconst keyUsageBits = new Uint8Array([0b00000000]);\n\t\tif (keyUsage?.digitalSignature) {\n\t\t\tkeyUsageBits[0] |= 0b00000001;\n\t\t}\n\t\tif (keyUsage?.nonRepudiation) {\n\t\t\tkeyUsageBits[0] |= 0b00000010;\n\t\t}\n\t\tif (keyUsage?.keyEncipherment) {\n\t\t\tkeyUsageBits[0] |= 0b00000100;\n\t\t}\n\t\tif (keyUsage?.dataEncipherment) {\n\t\t\tkeyUsageBits[0] |= 0b00001000;\n\t\t}\n\t\tif (keyUsage?.keyAgreement) {\n\t\t\tkeyUsageBits[0] |= 0b00010000;\n\t\t}\n\t\tif (keyUsage?.keyCertSign) {\n\t\t\tkeyUsageBits[0] |= 0b00100000;\n\t\t}\n\t\tif (keyUsage?.cRLSign) {\n\t\t\tkeyUsageBits[0] |= 0b01000000;\n\t\t}\n\t\tif (keyUsage?.encipherOnly) {\n\t\t\tkeyUsageBits[0] |= 0b10000000;\n\t\t}\n\t\tif (keyUsage?.decipherOnly) {\n\t\t\tkeyUsageBits[0] |= 0b01000000;\n\t\t}\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.objectIdentifier(oidByName('keyUsage')),\n\t\t\tASN1Encoder.boolean(true), // Critical\n\t\t\tASN1Encoder.octetString(ASN1Encoder.bitString(keyUsageBits)),\n\t\t]);\n\t}\n\n\tprivate static extKeyUsage(extKeyUsage: ExtKeyUsage = {}) {\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.objectIdentifier(oidByName('extKeyUsage')),\n\t\t\tASN1Encoder.boolean(true), // Critical\n\t\t\tASN1Encoder.octetString(\n\t\t\t\tASN1Encoder.sequence(\n\t\t\t\t\tObject.entries(extKeyUsage).map(([oidName, value]) => {\n\t\t\t\t\t\tif (value) {\n\t\t\t\t\t\t\treturn ASN1Encoder.objectIdentifier(\n\t\t\t\t\t\t\t\toidByName(oidName as OIDName)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn ASN1Encoder.null();\n\t\t\t\t\t})\n\t\t\t\t)\n\t\t\t),\n\t\t]);\n\t}\n\n\tprivate static nsCertType(nsCertType: NSCertType) {\n\t\tconst bits = new Uint8Array([0x00]);\n\t\tif (nsCertType.client) {\n\t\t\tbits[0] |= 0x01;\n\t\t}\n\t\tif (nsCertType.server) {\n\t\t\tbits[0] |= 0x02;\n\t\t}\n\t\tif (nsCertType.email) {\n\t\t\tbits[0] |= 0x04;\n\t\t}\n\t\tif (nsCertType.objsign) {\n\t\t\tbits[0] |= 0x08;\n\t\t}\n\t\tif (nsCertType.sslCA) {\n\t\t\tbits[0] |= 0x10;\n\t\t}\n\t\tif (nsCertType.emailCA) {\n\t\t\tbits[0] |= 0x20;\n\t\t}\n\t\tif (nsCertType.objCA) {\n\t\t\tbits[0] |= 0x40;\n\t\t}\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.objectIdentifier(oidByName('nsCertType')),\n\t\t\tASN1Encoder.octetString(bits),\n\t\t]);\n\t}\n\n\tprivate static subjectAltName(altNames: SubjectAltNames) {\n\t\tconst generalNames =\n\t\t\taltNames.dnsNames?.map((name) => {\n\t\t\t\tconst dnsName = ASN1Encoder.ia5String(name);\n\t\t\t\treturn ASN1Encoder.contextSpecific(2, dnsName);\n\t\t\t}) || [];\n\t\tconst ipAddresses =\n\t\t\taltNames.ipAddresses?.map((ip) => {\n\t\t\t\tconst ipAddress = ASN1Encoder.ia5String(ip);\n\t\t\t\treturn ASN1Encoder.contextSpecific(7, ipAddress);\n\t\t\t}) || [];\n\t\tconst sanExtensionValue = ASN1Encoder.octetString(\n\t\t\tASN1Encoder.sequence([...generalNames, ...ipAddresses])\n\t\t);\n\t\treturn ASN1Encoder.sequence([\n\t\t\tASN1Encoder.objectIdentifier(oidByName('subjectAltName')),\n\t\t\tASN1Encoder.boolean(true),\n\t\t\tsanExtensionValue,\n\t\t]);\n\t}\n}\n\n/**\n * OIDs used in X.509 certificates.\n *\n * Source: https://oidref.com/\n */\nconst oids = {\n\t// Algorithm OIDs\n\t'1.2.840.113549.1.1.1': 'rsaEncryption',\n\t'1.2.840.113549.1.1.4': 'md5WithRSAEncryption',\n\t'1.2.840.113549.1.1.5': 'sha1WithRSAEncryption',\n\t'1.2.840.113549.1.1.7': 'RSAES-OAEP',\n\t'1.2.840.113549.1.1.8': 'mgf1',\n\t'1.2.840.113549.1.1.9': 'pSpecified',\n\t'1.2.840.113549.1.1.10': 'RSASSA-PSS',\n\t'1.2.840.113549.1.1.11': 'sha256WithRSAEncryption',\n\t'1.2.840.113549.1.1.12': 'sha384WithRSAEncryption',\n\t'1.2.840.113549.1.1.13': 'sha512WithRSAEncryption',\n\t'1.3.101.112': 'EdDSA25519',\n\t'1.2.840.10040.4.3': 'dsa-with-sha1',\n\t'1.3.14.3.2.7': 'desCBC',\n\t'1.3.14.3.2.26': 'sha1',\n\t'1.3.14.3.2.29': 'sha1WithRSASignature',\n\t'2.16.840.1.101.3.4.2.1': 'sha256',\n\t'2.16.840.1.101.3.4.2.2': 'sha384',\n\t'2.16.840.1.101.3.4.2.3': 'sha512',\n\t'2.16.840.1.101.3.4.2.4': 'sha224',\n\t'2.16.840.1.101.3.4.2.5': 'sha512-224',\n\t'2.16.840.1.101.3.4.2.6': 'sha512-256',\n\t'1.2.840.113549.2.2': 'md2',\n\t'1.2.840.113549.2.5': 'md5',\n\n\t// pkcs#7 content types\n\t'1.2.840.113549.1.7.1': 'data',\n\t'1.2.840.113549.1.7.2': 'signedData',\n\t'1.2.840.113549.1.7.3': 'envelopedData',\n\t'1.2.840.113549.1.7.4': 'signedAndEnvelopedData',\n\t'1.2.840.113549.1.7.5': 'digestedData',\n\t'1.2.840.113549.1.7.6': 'encryptedData',\n\n\t// pkcs#9 oids\n\t'1.2.840.113549.1.9.1': 'emailAddress',\n\t'1.2.840.113549.1.9.2': 'unstructuredName',\n\t'1.2.840.113549.1.9.3': 'contentType',\n\t'1.2.840.113549.1.9.4': 'messageDigest',\n\t'1.2.840.113549.1.9.5': 'signingTime',\n\t'1.2.840.113549.1.9.6': 'counterSignature',\n\t'1.2.840.113549.1.9.7': 'challengePassword',\n\t'1.2.840.113549.1.9.8': 'unstructuredAddress',\n\t'1.2.840.113549.1.9.14': 'extensionRequest',\n\t'1.2.840.113549.1.9.20': 'friendlyName',\n\t'1.2.840.113549.1.9.21': 'localKeyId',\n\t'1.2.840.113549.1.9.22.1': 'x509Certificate',\n\n\t// pkcs#12 safe bags\n\t'1.2.840.113549.1.12.10.1.1': 'keyBag',\n\t'1.2.840.113549.1.12.10.1.2': 'pkcs8ShroudedKeyBag',\n\t'1.2.840.113549.1.12.10.1.3': 'certBag',\n\t'1.2.840.113549.1.12.10.1.4': 'crlBag',\n\t'1.2.840.113549.1.12.10.1.5': 'secretBag',\n\t'1.2.840.113549.1.12.10.1.6': 'safeContentsBag',\n\n\t// password-based-encryption for pkcs#12\n\t'1.2.840.113549.1.5.13': 'pkcs5PBES2',\n\t'1.2.840.113549.1.5.12': 'pkcs5PBKDF2',\n\t'1.2.840.113549.1.12.1.1': 'pbeWithSHAAnd128BitRC4',\n\t'1.2.840.113549.1.12.1.2': 'pbeWithSHAAnd40BitRC4',\n\t'1.2.840.113549.1.12.1.3': 'pbeWithSHAAnd3-KeyTripleDES-CBC',\n\t'1.2.840.113549.1.12.1.4': 'pbeWithSHAAnd2-KeyTripleDES-CBC',\n\t'1.2.840.113549.1.12.1.5': 'pbeWithSHAAnd128BitRC2-CBC',\n\t'1.2.840.113549.1.12.1.6': 'pbewithSHAAnd40BitRC2-CBC',\n\n\t// hmac OIDs\n\t'1.2.840.113549.2.7': 'hmacWithSHA1',\n\t'1.2.840.113549.2.8': 'hmacWithSHA224',\n\t'1.2.840.113549.2.9': 'hmacWithSHA256',\n\t'1.2.840.113549.2.10': 'hmacWithSHA384',\n\t'1.2.840.113549.2.11': 'hmacWithSHA512',\n\n\t// symmetric key algorithm oids\n\t'1.2.840.113549.3.7': 'des-EDE3-CBC',\n\t'2.16.840.1.101.3.4.1.2': 'aes128-CBC',\n\t'2.16.840.1.101.3.4.1.22': 'aes192-CBC',\n\t'2.16.840.1.101.3.4.1.42': 'aes256-CBC',\n\n\t// certificate issuer/subject OIDs\n\t'2.5.4.3': 'commonName',\n\t'2.5.4.4': 'surname',\n\t'2.5.4.5': 'serialNumber',\n\t'2.5.4.6': 'countryName',\n\t'2.5.4.7': 'localityName',\n\t'2.5.4.8': 'stateOrProvinceName',\n\t'2.5.4.9': 'streetAddress',\n\t'2.5.4.10': 'organizationName',\n\t'2.5.4.11': 'organizationalUnitName',\n\t'2.5.4.12': 'title',\n\t'2.5.4.13': 'description',\n\t'2.5.4.15': 'businessCategory',\n\t'2.5.4.17': 'postalCode',\n\t'2.5.4.42': 'givenName',\n\t'1.3.6.1.4.1.311.60.2.1.2':\n\t\t'jurisdictionOfIncorporationStateOrProvinceName',\n\t'1.3.6.1.4.1.311.60.2.1.3': 'jurisdictionOfIncorporationCountryName',\n\n\t// X.509 extension OIDs\n\t'2.16.840.1.113730.1.1': 'nsCertType',\n\t'2.16.840.1.113730.1.13': 'nsComment',\n\t'2.5.29.14': 'subjectKeyIdentifier',\n\t'2.5.29.15': 'keyUsage',\n\t'2.5.29.17': 'subjectAltName',\n\t'2.5.29.18': 'issuerAltName',\n\t'2.5.29.19': 'basicConstraints',\n\t'2.5.29.31': 'cRLDistributionPoints',\n\t'2.5.29.32': 'certificatePolicies',\n\t'2.5.29.35': 'authorityKeyIdentifier',\n\t'2.5.29.37': 'extKeyUsage',\n\n\t// extKeyUsage purposes\n\t'1.3.6.1.4.1.11129.2.4.2': 'timestampList',\n\t'1.3.6.1.5.5.7.1.1': 'authorityInfoAccess',\n\t'1.3.6.1.5.5.7.3.1': 'serverAuth',\n\t'1.3.6.1.5.5.7.3.2': 'clientAuth',\n\t'1.3.6.1.5.5.7.3.3': 'codeSigning',\n\t'1.3.6.1.5.5.7.3.4': 'emailProtection',\n\t'1.3.6.1.5.5.7.3.8': 'timeStamping',\n} as const;\n\nfunction oidByName(requestedName: OIDName): OID {\n\tfor (const [oid, name] of Object.entries(oids)) {\n\t\tif (name === requestedName) {\n\t\t\treturn oid as OID;\n\t\t}\n\t}\n\tthrow new Error(`OID not found for name: ${requestedName}`);\n}\n\nconst constructedBit = 0b00100000;\nconst ASN1Tags = {\n\tEOC: 0,\n\tBoolean: 1,\n\tInteger: 2,\n\tBitString: 3,\n\tOctetString: 4,\n\tNull: 5,\n\tOID: 6,\n\tObjectDescriptor: 7,\n\tExternal: 8,\n\tReal: 9, // float\n\tEnumeration: 10,\n\tPDV: 11,\n\tUtf8String: 12,\n\tRelativeOID: 13,\n\tSequence: 16 | constructedBit,\n\tSet: 17 | constructedBit,\n\tNumericString: 18,\n\tPrintableString: 19,\n\tT61String: 20,\n\tVideotexString: 21,\n\tIA5String: 22,\n\tUTCTime: 23,\n\tGeneralizedTime: 24,\n\tGraphicString: 25,\n\tVisibleString: 26,\n\tGeneralString: 28,\n\tUniversalString: 29,\n\tCharacterString: 30,\n\tBMPString: 31,\n\tConstructor: 32,\n\tContext: 128,\n};\n\nclass ASN1Encoder {\n\t// Helper functions for ASN.1 DER encoding\n\tstatic length_(length: number): Uint8Array {\n\t\tif (length < 0x80) {\n\t\t\t// Short form: single byte length\n\t\t\treturn new Uint8Array([length]);\n\t\t} else {\n\t\t\t// Long form: first byte is 0x80 + number of length bytes\n\t\t\t// Subsequent bytes are the length, big-endian\n\t\t\tlet tempLength = length;\n\t\t\tconst lengthBytesArray: number[] = [];\n\t\t\twhile (tempLength > 0) {\n\t\t\t\tlengthBytesArray.unshift(tempLength & 0xff);\n\t\t\t\ttempLength >>= 8;\n\t\t\t}\n\t\t\tconst numLengthBytes = lengthBytesArray.length;\n\t\t\tconst result = new Uint8Array(1 + numLengthBytes);\n\t\t\tresult[0] = 0x80 | numLengthBytes;\n\t\t\tfor (let i = 0; i < numLengthBytes; i++) {\n\t\t\t\tresult[i + 1] = lengthBytesArray[i];\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t}\n\n\tstatic ASN1(tag: number, data: Uint8Array): Uint8Array {\n\t\tconst lengthBytes = ASN1Encoder.length_(data.length);\n\t\tconst result = new Uint8Array(1 + lengthBytes.length + data.length);\n\t\tresult[0] = tag;\n\t\tresult.set(lengthBytes, 1);\n\t\tresult.set(data, 1 + lengthBytes.length);\n\t\treturn result;\n\t}\n\n\tstatic integer(number: Uint8Array): Uint8Array {\n\t\t// Ensure number is positive and first bit is 0\n\t\tif (number[0] > 0x7f) {\n\t\t\tconst extendedNumber = new Uint8Array(number.length + 1);\n\t\t\textendedNumber[0] = 0x00;\n\t\t\textendedNumber.set(number, 1);\n\t\t\tnumber = extendedNumber;\n\t\t}\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.Integer, number);\n\t}\n\n\tstatic bitString(data: Uint8Array): Uint8Array {\n\t\tconst unusedBits = new Uint8Array([0x00]);\n\t\tconst combined = new Uint8Array(unusedBits.length + data.length);\n\t\tcombined.set(unusedBits);\n\t\tcombined.set(data, unusedBits.length);\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.BitString, combined);\n\t}\n\n\tstatic octetString(data: Uint8Array): Uint8Array {\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.OctetString, data);\n\t}\n\n\tstatic null(): Uint8Array {\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.Null, new Uint8Array(0));\n\t}\n\n\tstatic objectIdentifier(oid: string): Uint8Array {\n\t\tconst oidParts = oid.split('.').map(Number);\n\t\tconst firstByte = oidParts[0] * 40 + oidParts[1];\n\t\tconst encodedParts = [firstByte];\n\t\tfor (let i = 2; i < oidParts.length; i++) {\n\t\t\tlet value = oidParts[i];\n\t\t\tconst bytes: number[] = [];\n\t\t\tdo {\n\t\t\t\tbytes.unshift(value & 0x7f);\n\t\t\t\tvalue >>= 7;\n\t\t\t} while (value > 0);\n\t\t\tfor (let j = 0; j < bytes.length - 1; j++) {\n\t\t\t\tbytes[j] |= 0x80;\n\t\t\t}\n\t\t\tencodedParts.push(...bytes);\n\t\t}\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.OID, new Uint8Array(encodedParts));\n\t}\n\n\tstatic utf8String(str: string): Uint8Array {\n\t\tconst utf8Bytes = new TextEncoder().encode(str);\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.Utf8String, utf8Bytes);\n\t}\n\n\tstatic printableString(str: string): Uint8Array {\n\t\tconst utf8Bytes = new TextEncoder().encode(str);\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.PrintableString, utf8Bytes);\n\t}\n\n\tstatic sequence(items: Uint8Array[]): Uint8Array {\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.Sequence, concatUint8Arrays(items));\n\t}\n\n\tstatic set(items: Uint8Array[]): Uint8Array {\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.Set, concatUint8Arrays(items));\n\t}\n\n\tstatic ia5String(str: string): Uint8Array {\n\t\tconst utf8Bytes = new TextEncoder().encode(str);\n\t\treturn ASN1Encoder.ASN1(ASN1Tags.IA5String, utf8Bytes);\n\t}\n\n\tstatic contextSpecific(\n\t\ttagNumber: number,\n\t\tdata: Uint8Array,\n\t\tconstructed = false\n\t): Uint8Array {\n\t\tconst tag = (constructed ? 0xa0 : 0x80) | tagNumber;\n\t\treturn ASN1Encoder.ASN1(tag, data);\n\t}\n\n\tstatic boolean(value: boolean): Uint8Array {\n\t\treturn ASN1Encoder.ASN1(\n\t\t\tASN1Tags.Boolean,\n\t\t\tnew Uint8Array([value ? 0xff : 0x00])\n\t\t);\n\t}\n}\n\nexport interface DistinguishedName {\n\tcountryName?: string;\n\torganizationName?: string;\n\tcommonName?: string;\n\tlocalityName?: string;\n\tstateOrProvinceName?: string;\n\tstreetAddress?: string;\n\tpostalCode?: string;\n\temailAddress?: string;\n\torganizationalUnitName?: string;\n\ttitle?: string;\n\tdescription?: string;\n\tbusinessCategory?: string;\n}\n\nexport type Validity = {\n\tnotBefore: Date;\n\tnotAfter: Date;\n};\n\nexport type OID = keyof typeof oids;\nexport type OIDName = (typeof oids)[OID];\n\nexport interface BasicConstraints {\n\tca: boolean;\n\tpathLenConstraint?: number;\n}\n\nexport interface KeyUsage {\n\tdigitalSignature?: boolean;\n\tnonRepudiation?: boolean;\n\tkeyEncipherment?: boolean;\n\tdataEncipherment?: boolean;\n\tkeyAgreement?: boolean;\n\tkeyCertSign?: boolean;\n\tcRLSign?: boolean;\n\tencipherOnly?: boolean;\n\tdecipherOnly?: boolean;\n}\n\nexport interface ExtKeyUsage {\n\tserverAuth?: boolean;\n\tclientAuth?: boolean;\n\tcodeSigning?: boolean;\n\temailProtection?: boolean;\n\ttimeStamping?: boolean;\n}\n\nexport interface NSCertType {\n\tclient?: boolean;\n\tserver?: boolean;\n\temail?: boolean;\n\tobjsign?: boolean;\n\tsslCA?: boolean;\n\temailCA?: boolean;\n\tobjCA?: boolean;\n}\n\nexport interface SubjectAltNames {\n\tdnsNames?: string[];\n\tipAddresses?: string[];\n}\n\nexport interface TBSCertificateDescription {\n\tversion?: number;\n\tserialNumber?: Uint8Array;\n\tsignatureAlgorithm?: OIDName;\n\tissuer?: DistinguishedName;\n\tvalidity?: Validity;\n\tsubject: DistinguishedName;\n\tbasicConstraints?: BasicConstraints;\n\tkeyUsage?: KeyUsage;\n\textKeyUsage?: ExtKeyUsage;\n\tsubjectAltNames?: SubjectAltNames;\n\tnsCertType?: NSCertType;\n}\nexport type TBSCertificate = Uint8Array;\n\nexport type GeneratedCertificate = {\n\tkeyPair: CryptoKeyPair;\n\tcertificate: Uint8Array;\n\ttbsDescription: TBSCertificateDescription;\n\ttbsCertificate: TBSCertificate;\n};\n\n// Helper functions\nfunction encodeUint8ArrayAsBase64(bytes: ArrayBuffer) {\n\treturn btoa(String.fromCodePoint(...new Uint8Array(bytes)));\n}\n\nfunction formatPEM(pemString: string): string {\n\treturn pemString.match(/.{1,64}/g)?.join('\\n') || pemString;\n}\n\nfunction formatDateASN1(date: Date): string {\n\t// Format date to YYMMDDHHMMSSZ for UTCTime\n\tconst year = date.getUTCFullYear().toString().substr(2);\n\tconst month = padNumber(date.getUTCMonth() + 1);\n\tconst day = padNumber(date.getUTCDate());\n\tconst hours = padNumber(date.getUTCHours());\n\tconst minutes = padNumber(date.getUTCMinutes());\n\tconst seconds = padNumber(date.getUTCSeconds());\n\treturn `${year}${month}${day}${hours}${minutes}${seconds}Z`;\n}\n\nfunction padNumber(num: number): string {\n\treturn num.toString().padStart(2, '0');\n}\n\nfunction addYears(date: Date, years: number): Date {\n\tconst newDate = new Date(date);\n\tnewDate.setUTCFullYear(newDate.getUTCFullYear() + years);\n\treturn newDate;\n}\n","import { cloneRequest } from '@php-wasm/web-service-worker';\n\nexport async function fetchWithCorsProxy(\n\tinput: RequestInfo,\n\tinit?: RequestInit,\n\tcorsProxyUrl?: string\n): Promise<Response> {\n\tconst directFetch = fetch(input, init);\n\tif (!corsProxyUrl) {\n\t\treturn directFetch;\n\t}\n\n\ttry {\n\t\treturn await directFetch;\n\t} catch {\n\t\tlet newInput: string | Request;\n\t\tif (typeof input === 'string' || input instanceof URL) {\n\t\t\tnewInput = `${corsProxyUrl}${input}`;\n\t\t} else if (input instanceof Request) {\n\t\t\tnewInput = await cloneRequest(input, {\n\t\t\t\turl: `${corsProxyUrl}${input.url}`,\n\t\t\t});\n\t\t} else {\n\t\t\tthrow new Error('Invalid input type for fetch');\n\t\t}\n\n\t\treturn fetch(newInput, init);\n\t}\n}\n","/**\n * This is the secret sauce that enables HTTPS requests from PHP\n * via file_get_contents(), curl, and all other networking mechanisms.\n *\n * This is effectively a MITM attack on the PHP instance. The code\n * in this module decrypts the outbound traffic, runs the request\n * using fetch(), and then provides an encrypted response. From\n * PHP's perspective, it is indistinguishable from a direct connection\n * to the right server.\n *\n * ## How does it work?\n *\n * Emscripten can be configured to stream all network traffic through a\n * WebSocket. `@php-wasm/node` and `wp-now` use that to access the internet\n * via a local WebSocket->TCP proxy, but the in-browser version of WordPress\n * Playground exposes no such proxy.\n *\n * This module implements a \"fake\" WebSocket class. Instead of starting a `ws://`\n * connection, it translates the raw HTTP/HTTPS bytes into a `fetch()` call.\n *\n * In case of HTTP, the raw request bytes are parsed into a Request object with\n * a body stream and passes it to `fetch()`. Then, as the response status, headers,\n * and the body arrive, they're stream-encoded as raw response bytes and exposed as\n * incoming WebSocket data.\n *\n * In case of HTTPS, we the raw bytes are first piped through a custom TCPConnection\n * class as follows:\n *\n * 1. We generate a self-signed CA certificate and tell PHP to trust it using the\n *    `openssl.cafile` PHP.ini option\n * 2. We create a domain-specific child certificate and sign it with the CA private key.\n * 3. We start accepting raw encrypted bytes, process them as structured TLS records,\n *    and perform the TLS handshake.\n * 4. Encrypted tunnel is established\n *   * TLSConnection decrypts the encrypted outbound data sent by PHP\n *   * TLSConnection encrypts the unencrypted inbound data fed back to PHP\n *\n * From there, the plaintext data is treated by the same HTTP<->fetch() machinery as\n * described in the previous paragraph.\n */\nimport { TLS_1_2_Connection } from './tls/1_2/connection';\nimport { generateCertificate, GeneratedCertificate } from './tls/certificates';\nimport { concatUint8Arrays } from './tls/utils';\nimport { ContentTypes } from './tls/1_2/types';\nimport { fetchWithCorsProxy } from './fetch-with-cors-proxy';\n\nexport type TCPOverFetchOptions = {\n\tCAroot: GeneratedCertificate;\n\tcorsProxyUrl?: string;\n};\n\n/**\n * Sets up a WebSocket that analyzes the received bytes and, if they look like\n * TLS or HTTP, handles the network transmission using fetch().\n */\nexport const tcpOverFetchWebsocket = (tcpOptions: TCPOverFetchOptions) => {\n\treturn {\n\t\twebsocket: {\n\t\t\turl: (_: any, host: string, port: string) => {\n\t\t\t\tconst query = new URLSearchParams({\n\t\t\t\t\thost,\n\t\t\t\t\tport,\n\t\t\t\t}).toString();\n\t\t\t\treturn `ws://playground.internal/?${query}`;\n\t\t\t},\n\t\t\tsubprotocol: 'binary',\n\t\t\tdecorator: () => {\n\t\t\t\treturn class extends TCPOverFetchWebsocket {\n\t\t\t\t\tconstructor(url: string, wsOptions: string[]) {\n\t\t\t\t\t\tsuper(url, wsOptions, {\n\t\t\t\t\t\t\tCAroot: tcpOptions.CAroot,\n\t\t\t\t\t\t\tcorsProxyUrl: tcpOptions.corsProxyUrl,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\t\t},\n\t};\n};\n\nexport interface TCPOverFetchWebsocketOptions {\n\tCAroot?: GeneratedCertificate;\n\t/**\n\t * If true, the WebSocket will emit 'message' events with the received bytes\n\t * and the 'close' event when the WebSocket is closed.\n\t *\n\t * If false, the consumer will be responsible for reading the bytes from the\n\t * clientDownstream stream and tracking the closure of that stream.\n\t */\n\toutputType?: 'messages' | 'stream';\n\tcorsProxyUrl?: string;\n}\n\nexport class TCPOverFetchWebsocket {\n\tCONNECTING = 0;\n\tOPEN = 1;\n\tCLOSING = 2;\n\tCLOSED = 3;\n\treadyState = this.CONNECTING;\n\tbinaryType = 'blob';\n\tbufferedAmount = 0;\n\textensions = '';\n\tprotocol = 'ws';\n\thost = '';\n\tport = 0;\n\tlisteners = new Map<string, any>();\n\tCAroot?: GeneratedCertificate;\n\tcorsProxyUrl?: string;\n\n\tclientUpstream = new TransformStream();\n\tclientUpstreamWriter = this.clientUpstream.writable.getWriter();\n\tclientDownstream = new TransformStream();\n\tfetchInitiated = false;\n\tbufferedBytesFromClient: Uint8Array = new Uint8Array(0);\n\n\tconstructor(\n\t\tpublic url: string,\n\t\tpublic options: string[],\n\t\t{\n\t\t\tCAroot,\n\t\t\tcorsProxyUrl,\n\t\t\toutputType = 'messages',\n\t\t}: TCPOverFetchWebsocketOptions = {}\n\t) {\n\t\tconst wsUrl = new URL(url);\n\t\tthis.host = wsUrl.searchParams.get('host')!;\n\t\tthis.port = parseInt(wsUrl.searchParams.get('port')!, 10);\n\t\tthis.binaryType = 'arraybuffer';\n\n\t\tthis.corsProxyUrl = corsProxyUrl;\n\t\tthis.CAroot = CAroot;\n\t\tif (outputType === 'messages') {\n\t\t\tthis.clientDownstream.readable\n\t\t\t\t.pipeTo(\n\t\t\t\t\tnew WritableStream({\n\t\t\t\t\t\twrite: (chunk) => {\n\t\t\t\t\t\t\t/**\n\t\t\t\t\t\t\t * Emscripten expects the message event to be emitted\n\t\t\t\t\t\t\t * so let's emit it.\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\tthis.emit('message', { data: chunk });\n\t\t\t\t\t\t},\n\t\t\t\t\t\tabort: () => {\n\t\t\t\t\t\t\t// We don't know what went wrong and the browser\n\t\t\t\t\t\t\t// won't tell us much either, so let's just pretend\n\t\t\t\t\t\t\t// the server is unreachable.\n\t\t\t\t\t\t\tthis.emit('error', new Error('ECONNREFUSED'));\n\t\t\t\t\t\t\tthis.close();\n\t\t\t\t\t\t},\n\t\t\t\t\t\tclose: () => {\n\t\t\t\t\t\t\tthis.close();\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t)\n\t\t\t\t.catch(() => {\n\t\t\t\t\t// Ignore failures arising from stream errors.\n\t\t\t\t\t// This class communicates problems to the caller\n\t\t\t\t\t// via the 'error' event.\n\t\t\t\t});\n\t\t}\n\t\tthis.readyState = this.OPEN;\n\t\tthis.emit('open');\n\t}\n\n\ton(eventName: string, callback: (e: any) => void) {\n\t\tthis.addEventListener(eventName, callback);\n\t}\n\n\tonce(eventName: string, callback: (e: any) => void) {\n\t\tconst wrapper = (e: any) => {\n\t\t\tcallback(e);\n\t\t\tthis.removeEventListener(eventName, wrapper);\n\t\t};\n\t\tthis.addEventListener(eventName, wrapper);\n\t}\n\n\taddEventListener(eventName: string, callback: (e: any) => void) {\n\t\tif (!this.listeners.has(eventName)) {\n\t\t\tthis.listeners.set(eventName, new Set());\n\t\t}\n\t\tthis.listeners.get(eventName).add(callback);\n\t}\n\n\tremoveListener(eventName: string, callback: (e: any) => void) {\n\t\tthis.removeEventListener(eventName, callback);\n\t}\n\n\tremoveEventListener(eventName: string, callback: (e: any) => void) {\n\t\tconst listeners = this.listeners.get(eventName);\n\t\tif (listeners) {\n\t\t\tlisteners.delete(callback);\n\t\t}\n\t}\n\n\temit(eventName: string, data: any = {}) {\n\t\tif (eventName === 'message') {\n\t\t\tthis.onmessage(data);\n\t\t} else if (eventName === 'close') {\n\t\t\tthis.onclose(data);\n\t\t} else if (eventName === 'error') {\n\t\t\tthis.onerror(data);\n\t\t} else if (eventName === 'open') {\n\t\t\tthis.onopen(data);\n\t\t}\n\t\tconst listeners = this.listeners.get(eventName);\n\t\tif (listeners) {\n\t\t\tfor (const listener of listeners) {\n\t\t\t\tlistener(data);\n\t\t\t}\n\t\t}\n\t}\n\n\t// Default event handlers that can be overridden by the user\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tonclose(data: any) {}\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tonerror(data: any) {}\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tonmessage(data: any) {}\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tonopen(data: any) {}\n\n\t/**\n\t * Emscripten calls this method whenever the WASM module\n\t * writes bytes to the TCP socket.\n\t */\n\tsend(data: ArrayBuffer) {\n\t\tif (\n\t\t\tthis.readyState === this.CLOSING ||\n\t\t\tthis.readyState === this.CLOSED\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.clientUpstreamWriter.write(new Uint8Array(data));\n\n\t\tif (this.fetchInitiated) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Guess the protocol type first so we can learn\n\t\t// what to do with the incoming bytes.\n\t\tthis.bufferedBytesFromClient = concatUint8Arrays([\n\t\t\tthis.bufferedBytesFromClient,\n\t\t\tnew Uint8Array(data),\n\t\t]);\n\t\tswitch (guessProtocol(this.port, this.bufferedBytesFromClient)) {\n\t\t\tcase false:\n\t\t\t\t// Not enough data to classify the protocol,\n\t\t\t\t// let's wait for more.\n\t\t\t\treturn;\n\t\t\tcase 'other':\n\t\t\t\tthis.emit('error', new Error('Unsupported protocol'));\n\t\t\t\tthis.close();\n\t\t\t\tbreak;\n\t\t\tcase 'tls':\n\t\t\t\tthis.fetchOverTLS();\n\t\t\t\tthis.fetchInitiated = true;\n\t\t\t\tbreak;\n\t\t\tcase 'http':\n\t\t\t\tthis.fetchOverHTTP();\n\t\t\t\tthis.fetchInitiated = true;\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tasync fetchOverTLS() {\n\t\tif (!this.CAroot) {\n\t\t\tthrow new Error(\n\t\t\t\t'TLS protocol is only supported when the TCPOverFetchWebsocket is ' +\n\t\t\t\t\t'instantiated with a CAroot'\n\t\t\t);\n\t\t}\n\t\tconst siteCert = await generateCertificate(\n\t\t\t{\n\t\t\t\tsubject: {\n\t\t\t\t\tcommonName: this.host,\n\t\t\t\t\torganizationName: this.host,\n\t\t\t\t\tcountryName: 'US',\n\t\t\t\t},\n\t\t\t\tissuer: this.CAroot.tbsDescription.subject,\n\t\t\t},\n\t\t\tthis.CAroot.keyPair\n\t\t);\n\n\t\tconst tlsConnection = new TLS_1_2_Connection();\n\n\t\t// Connect this WebSocket's client end to the TLS connection.\n\t\t// Forward the encrypted bytes from the WebSocket to the TLS connection.\n\t\tthis.clientUpstream.readable\n\t\t\t.pipeTo(tlsConnection.clientEnd.upstream.writable)\n\t\t\t.catch(() => {\n\t\t\t\t// Ignore failures arising from pipeTo() errors.\n\t\t\t\t// The caller will observe the clientEnd.downstream.writable stream\n\t\t\t\t// erroring out.\n\t\t\t});\n\n\t\t// Forward the decrypted bytes from the TLS connection to this WebSocket.\n\t\ttlsConnection.clientEnd.downstream.readable\n\t\t\t.pipeTo(this.clientDownstream.writable)\n\t\t\t.catch(() => {\n\t\t\t\t// Ignore failures arising from pipeTo() errors.\n\t\t\t\t// The caller will observe the clientEnd.downstream.writable stream\n\t\t\t\t// erroring out.\n\t\t\t});\n\n\t\t// Perform the TLS handshake\n\t\tawait tlsConnection.TLSHandshake(siteCert.keyPair.privateKey, [\n\t\t\tsiteCert.certificate,\n\t\t\tthis.CAroot.certificate,\n\t\t]);\n\n\t\t// Connect the TLS server end to the fetch() request\n\t\tconst request = await RawBytesFetch.parseHttpRequest(\n\t\t\ttlsConnection.serverEnd.upstream.readable,\n\t\t\tthis.host,\n\t\t\t'https'\n\t\t);\n\t\ttry {\n\t\t\tawait RawBytesFetch.fetchRawResponseBytes(\n\t\t\t\trequest,\n\t\t\t\tthis.corsProxyUrl\n\t\t\t).pipeTo(tlsConnection.serverEnd.downstream.writable);\n\t\t} catch (e) {\n\t\t\t// Ignore errors from fetch()\n\t\t\t// They are handled in the constructor\n\t\t\t// via this.clientDownstream.readable.pipeTo()\n\t\t\t// and if we let the failures they would be logged\n\t\t\t// as an unhandled promise rejection.\n\t\t}\n\t}\n\n\tasync fetchOverHTTP() {\n\t\t// Connect this WebSocket's client end to the fetch() request\n\t\tconst request = await RawBytesFetch.parseHttpRequest(\n\t\t\tthis.clientUpstream.readable,\n\t\t\tthis.host,\n\t\t\t'http'\n\t\t);\n\t\ttry {\n\t\t\tawait RawBytesFetch.fetchRawResponseBytes(\n\t\t\t\trequest,\n\t\t\t\tthis.corsProxyUrl\n\t\t\t).pipeTo(this.clientDownstream.writable);\n\t\t} catch (e) {\n\t\t\t// Ignore errors from fetch()\n\t\t\t// They are handled in the constructor\n\t\t\t// via this.clientDownstream.readable.pipeTo()\n\t\t\t// and if we let the failures they would be logged\n\t\t\t// as an unhandled promise rejection.\n\t\t}\n\t}\n\n\tclose() {\n\t\t/**\n\t\t * Workaround a PHP.wasm issue – if the WebSocket is\n\t\t * closed asynchronously after the last chunk is received,\n\t\t * the PHP.wasm runtime enters an infinite polling loop.\n\t\t *\n\t\t * The root cause of the problem is unclear at the time\n\t\t * of writing this comment. There's a chance it's a regular\n\t\t * POSIX behavior.\n\t\t *\n\t\t * Either way, sending an empty data chunk before closing\n\t\t * the WebSocket resolves the problem.\n\t\t */\n\t\tthis.emit('message', { data: new Uint8Array(0) });\n\n\t\tthis.readyState = this.CLOSING;\n\t\tthis.emit('close');\n\t\tthis.readyState = this.CLOSED;\n\t}\n}\n\nconst HTTP_METHODS = [\n\t'GET',\n\t'POST',\n\t'HEAD',\n\t'PATCH',\n\t'OPTIONS',\n\t'DELETE',\n\t'PUT',\n\t'TRACE',\n];\n\nfunction guessProtocol(port: number, data: Uint8Array) {\n\tif (data.length < 8) {\n\t\t// Not enough data to classify the protocol, let's wait for more.\n\t\treturn false;\n\t}\n\n\t// Assume TLS if we're on the usual HTTPS port and the\n\t// first three bytes look like a TLS handshake record.\n\tconst looksLikeTls =\n\t\tport === 443 &&\n\t\tdata[0] === ContentTypes.Handshake &&\n\t\t// TLS versions between 1.0 and 1.2\n\t\tdata[1] === 0x03 &&\n\t\tdata[2] >= 0x01 &&\n\t\tdata[2] <= 0x03;\n\tif (looksLikeTls) {\n\t\treturn 'tls';\n\t}\n\n\t// Assume HTTP if we're on the usual HTTP port and the\n\t// first starts with an HTTP method and a space.\n\tconst decodedFirstLine = new TextDecoder('latin1', {\n\t\tfatal: true,\n\t}).decode(data);\n\tconst looksLikeHttp = HTTP_METHODS.some((method) =>\n\t\tdecodedFirstLine.startsWith(method + ' ')\n\t);\n\tif (looksLikeHttp) {\n\t\treturn 'http';\n\t}\n\n\treturn 'other';\n}\n\nclass RawBytesFetch {\n\t/**\n\t * Streams a HTTP response including the status line and headers.\n\t */\n\tstatic fetchRawResponseBytes(request: Request, corsProxyUrl?: string) {\n\t\t// This initially used a TransformStream and piped the response\n\t\t// body to the writable side of the TransformStream.\n\t\t//\n\t\t// Unfortunately, the first response body chunk was not correctly\n\t\t// enqueued so we switched to a customReadableStream.\n\t\treturn new ReadableStream({\n\t\t\tasync start(controller) {\n\t\t\t\tlet response: Response;\n\t\t\t\ttry {\n\t\t\t\t\tresponse = await fetchWithCorsProxy(\n\t\t\t\t\t\trequest,\n\t\t\t\t\t\tundefined,\n\t\t\t\t\t\tcorsProxyUrl\n\t\t\t\t\t);\n\t\t\t\t} catch (error) {\n\t\t\t\t\t/**\n\t\t\t\t\t * Pretend we've got a 400 Bad Request response whenever\n\t\t\t\t\t * the fetch() call fails.\n\t\t\t\t\t *\n\t\t\t\t\t * Just propagating an error and closing a WebSocket does\n\t\t\t\t\t * not make PHP aware the socket closed abruptly. This means\n\t\t\t\t\t * the AsyncHttp\\Client will keep polling the socket indefinitely\n\t\t\t\t\t * until the request times out. This isn't perfect, as we want\n\t\t\t\t\t * to close the socket as soon as possible to avoid, e.g., 10 seconds\n\t\t\t\t\t * of unnecessary waitin for the timeout\n\t\t\t\t\t *\n\t\t\t\t\t * The root cause is unknown and likely related to the low-level\n\t\t\t\t\t * implementation of polling file descriptors. The following\n\t\t\t\t\t * workaround is far from ideal, but it must suffice until we\n\t\t\t\t\t * have a platform-level resolution.\n\t\t\t\t\t */\n\t\t\t\t\tcontroller.enqueue(\n\t\t\t\t\t\tnew TextEncoder().encode(\n\t\t\t\t\t\t\t'HTTP/1.1 400 Bad Request\\r\\nContent-Length: 0\\r\\n\\r\\n'\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\tcontroller.error(error);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontroller.enqueue(RawBytesFetch.headersAsBytes(response));\n\t\t\t\tconst reader = response.body?.getReader();\n\t\t\t\tif (!reader) {\n\t\t\t\t\tcontroller.close();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst encoder = new TextEncoder();\n\t\t\t\twhile (true) {\n\t\t\t\t\tconst { done, value } = await reader.read();\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Pass the body stream assuming the response uses\n\t\t\t\t\t\t * chunked transfer encoding.\n\t\t\t\t\t\t *\n\t\t\t\t\t\t * See `headersAsBytes()` for the details.\n\t\t\t\t\t\t */\n\t\t\t\t\t\tcontroller.enqueue(\n\t\t\t\t\t\t\tencoder.encode(`${value.length.toString(16)}\\r\\n`)\n\t\t\t\t\t\t);\n\t\t\t\t\t\tcontroller.enqueue(value);\n\t\t\t\t\t\tcontroller.enqueue(encoder.encode('\\r\\n'));\n\t\t\t\t\t}\n\t\t\t\t\tif (done) {\n\t\t\t\t\t\tcontroller.enqueue(encoder.encode('0\\r\\n\\r\\n'));\n\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\tprivate static headersAsBytes(response: Response) {\n\t\tconst status = `HTTP/1.1 ${response.status} ${response.statusText}`;\n\n\t\tconst headersObject: Record<string, string> = {};\n\t\tresponse.headers.forEach((value, name) => {\n\t\t\theadersObject[name.toLowerCase()] = value;\n\t\t});\n\n\t\t/**\n\t\t * Best-effort attempt to provide the correct content-length\n\t\t * to the PHP-side request handler.\n\t\t *\n\t\t * Web servers often respond with a combination of Content-Length\n\t\t * and Content-Encoding. For example, a 16kb text file may be compressed\n\t\t * to 4kb with gzip and served with a Content-Encoding of `gzip` and a\n\t\t * Content-Length of 4KB.\n\t\t *\n\t\t * The web browser, however, exposes neither the Content-Encoding header\n\t\t * nor the gzipped data stream. All we have access to is the original\n\t\t * Content-Length value of the gzipped file and a decompressed data stream.\n\t\t *\n\t\t * If we just pass that along to the PHP-side request handler, it would\n\t\t * see a 16KB body stream with a Content-Length of 4KB. It would then\n\t\t * truncate the body stream at 4KB and discard the rest of the data.\n\t\t *\n\t\t * This is not what we want.\n\t\t *\n\t\t * To correct that behavior, we're stripping the Content-Length entirely.\n\t\t * We do that for every single response because we don't have any way\n\t\t * of knowing whether any Content-Encoding was used. Furthermore, we can't\n\t\t * just calculate the correct Content-Length value without consuming the\n\t\t * entire content stream – and we want to pass each data chunk to PHP\n\t\t * as we receive it.\n\t\t *\n\t\t * Instead of a fixed Content-Length, we'll use Content-Encoding: Chunked,\n\t\t * and then provide a per-chunk Content-Length. See fetchRawResponseBytes()\n\t\t * for the details.\n\t\t */\n\t\tdelete headersObject['content-length'];\n\t\theadersObject['transfer-encoding'] = 'chunked';\n\n\t\tconst headers: string[] = [];\n\t\tfor (const [name, value] of Object.entries(headersObject)) {\n\t\t\theaders.push(`${name}: ${value}`);\n\t\t}\n\t\tconst string = [status, ...headers].join('\\r\\n') + '\\r\\n\\r\\n';\n\t\treturn new TextEncoder().encode(string);\n\t}\n\n\t/**\n\t * Parses a raw, streamed HTTP request into a Request object\n\t * with known headers and a readable body stream.\n\t */\n\tstatic async parseHttpRequest(\n\t\trequestBytesStream: ReadableStream<Uint8Array>,\n\t\thost: string,\n\t\tprotocol: 'http' | 'https'\n\t) {\n\t\tlet inputBuffer: Uint8Array = new Uint8Array(0);\n\n\t\tlet requestDataExhausted = false;\n\t\tlet headersEndIndex = -1;\n\t\tconst requestBytesReader = requestBytesStream.getReader();\n\t\twhile (headersEndIndex === -1) {\n\t\t\tconst { done, value } = await requestBytesReader.read();\n\t\t\tif (done) {\n\t\t\t\trequestDataExhausted = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tinputBuffer = concatUint8Arrays([inputBuffer, value]);\n\t\t\t// Find the end of the headers (\\r\\n\\r\\n). This is\n\t\t\t// not optimal as we may end up scanning the same\n\t\t\t// bytes multiple times, but the overhead is negligible\n\t\t\t// and the code is much simpler this way.\n\t\t\theadersEndIndex = findSequenceInBuffer(\n\t\t\t\tinputBuffer,\n\t\t\t\tnew Uint8Array([0x0d, 0x0a, 0x0d, 0x0a])\n\t\t\t);\n\t\t}\n\t\trequestBytesReader.releaseLock();\n\n\t\tconst headersBuffer = inputBuffer.slice(0, headersEndIndex);\n\t\tconst parsedHeaders = RawBytesFetch.parseRequestHeaders(headersBuffer);\n\n\t\tconst bodyBytes = inputBuffer.slice(\n\t\t\theadersEndIndex + 4 /* Skip \\r\\n\\r\\n */\n\t\t);\n\t\tlet outboundBodyStream: ReadableStream<Uint8Array> | undefined;\n\t\tif (parsedHeaders.method !== 'GET') {\n\t\t\tconst requestBytesReader = requestBytesStream.getReader();\n\t\t\toutboundBodyStream = new ReadableStream<Uint8Array>({\n\t\t\t\tasync start(controller) {\n\t\t\t\t\tif (bodyBytes.length > 0) {\n\t\t\t\t\t\tcontroller.enqueue(bodyBytes);\n\t\t\t\t\t}\n\t\t\t\t\tif (requestDataExhausted) {\n\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tasync pull(controller) {\n\t\t\t\t\tconst { done, value } = await requestBytesReader.read();\n\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\tcontroller.enqueue(value);\n\t\t\t\t\t}\n\t\t\t\t\tif (done) {\n\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Prefer the Host header to the host from the URL used in a PHP\n\t\t * function call.\n\t\t *\n\t\t * There are tradeoffs involved in this decision.\n\t\t *\n\t\t * The URL from the PHP function call is the actual network location\n\t\t * the caller intended to reach, e.g. `http://192.168.1.100` or\n\t\t * `http://127.0.0.1`.\n\t\t *\n\t\t * The Host header is what the developer wanted to provide to the\n\t\t * web server, e.g. `wordpress.org` or `localhost`.\n\t\t *\n\t\t * The Host header is not a reliable indication of the target URL.\n\t\t * However, `fetch()` does not support Host spoofing. Furthermore,\n\t\t * a webserver running on 127.0.0.1 may only respond correctly\n\t\t * when it is provided with the Host header `localhost`.\n\t\t *\n\t\t * Prefering the Host header over the host from the PHP function call\n\t\t * is not perfect, but it seems like the lesser of two evils.\n\t\t */\n\t\tconst hostname = parsedHeaders.headers.get('Host') ?? host;\n\t\tconst url = new URL(parsedHeaders.path, protocol + '://' + hostname);\n\t\turl.pathname = parsedHeaders.path;\n\n\t\treturn new Request(url.toString(), {\n\t\t\tmethod: parsedHeaders.method,\n\t\t\theaders: parsedHeaders.headers,\n\t\t\tbody: outboundBodyStream,\n\t\t\t// In Node.js, duplex: 'half' is required when\n\t\t\t// the body stream is provided.\n\t\t\t// @ts-expect-error\n\t\t\tduplex: 'half',\n\t\t});\n\t}\n\n\tprivate static parseRequestHeaders(httpRequestBytes: Uint8Array) {\n\t\tconst httpRequest = new TextDecoder().decode(httpRequestBytes);\n\t\tconst statusLineMaybe = httpRequest.split('\\n')[0];\n\t\tconst [method, path] = statusLineMaybe.split(' ');\n\n\t\tconst headers = new Headers();\n\t\tfor (const line of httpRequest.split('\\r\\n').slice(1)) {\n\t\t\tif (line === '') {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst [name, value] = line.split(': ');\n\t\t\theaders.set(name, value);\n\t\t}\n\n\t\treturn { method, path, headers };\n\t}\n}\n\nfunction findSequenceInBuffer(\n\tbuffer: Uint8Array,\n\tsequence: Uint8Array\n): number {\n\tconst bufferLength = buffer.length;\n\tconst sequenceLength = sequence.length;\n\tconst lastPossibleIndex = bufferLength - sequenceLength;\n\n\tfor (let i = 0; i <= lastPossibleIndex; i++) {\n\t\tlet found = true;\n\t\tfor (let j = 0; j < sequenceLength; j++) {\n\t\t\tif (buffer[i + j] !== sequence[j]) {\n\t\t\t\tfound = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (found) {\n\t\t\treturn i;\n\t\t}\n\t}\n\treturn -1;\n}\n","import {\n\tEmscriptenOptions,\n\tloadPHPRuntime,\n\tPHPLoaderModule,\n\tSupportedPHPVersion,\n} from '@php-wasm/universal';\nimport { getPHPLoaderModule } from './get-php-loader-module';\nimport {\n\tTCPOverFetchOptions,\n\ttcpOverFetchWebsocket,\n} from './tcp-over-fetch-websocket';\n\nexport interface LoaderOptions {\n\temscriptenOptions?: EmscriptenOptions;\n\tonPhpLoaderModuleLoaded?: (module: PHPLoaderModule) => void;\n\ttcpOverFetch?: TCPOverFetchOptions;\n}\n\n/**\n * Fake a websocket connection to prevent errors in the web app\n * from cascading and breaking the Playground.\n */\nconst fakeWebsocket = () => {\n\treturn {\n\t\twebsocket: {\n\t\t\tdecorator: (WebSocketConstructor: any) => {\n\t\t\t\treturn class FakeWebsocketConstructor extends WebSocketConstructor {\n\t\t\t\t\tconstructor() {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tsuper();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t// pass\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tsend() {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\t\t},\n\t};\n};\n\nexport async function loadWebRuntime(\n\tphpVersion: SupportedPHPVersion,\n\toptions: LoaderOptions = {}\n) {\n\tconst phpLoaderModule = await getPHPLoaderModule(phpVersion);\n\toptions.onPhpLoaderModuleLoaded?.(phpLoaderModule);\n\tconst websocketExtension = options.tcpOverFetch\n\t\t? tcpOverFetchWebsocket(options.tcpOverFetch)\n\t\t: fakeWebsocket();\n\treturn await loadPHPRuntime(phpLoaderModule, {\n\t\t...(options.emscriptenOptions || {}),\n\t\t...websocketExtension,\n\t});\n}\n","/**\n * Setup a postMessage relay between the parent window and a nested iframe.\n *\n * When we're running a Playground instance inside an iframe, sometimes that\n * iframe will contain another iframe and so on. The parent application,\n * however, needs to be able to communicate with the innermost iframe. This\n * function relays the communication both ways. Call it in in every iframe\n * layer between the topmost window and the innermost iframe.\n *\n * @param nestedFrame The nested iframe element\n * @param expectedOrigin The origin that the nested iframe is expected to be on. If not\n *                       provided, any origin is allowed.\n */\nexport function setupPostMessageRelay(\n\tnestedFrame: HTMLIFrameElement,\n\texpectedOrigin?: string\n) {\n\t// Relay Messages from WP to Parent\n\twindow.addEventListener('message', (event) => {\n\t\tif (event.source !== nestedFrame.contentWindow) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (expectedOrigin && event.origin !== expectedOrigin) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof event.data !== 'object' || event.data.type !== 'relay') {\n\t\t\treturn;\n\t\t}\n\n\t\twindow.parent.postMessage(event.data, '*');\n\t});\n\n\t// Relay Messages from Parent to WP\n\twindow.addEventListener('message', (event) => {\n\t\tif (event.source !== window.parent) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof event.data !== 'object' || event.data.type !== 'relay') {\n\t\t\treturn;\n\t\t}\n\n\t\tnestedFrame?.contentWindow?.postMessage(event.data);\n\t});\n}\n","/**\n * Spawns a new Worker Thread.\n *\n * @param  workerUrl The absolute URL of the worker script.\n * @returns The spawned Worker Thread.\n */\nexport async function spawnPHPWorkerThread(workerUrl: string) {\n\tconst worker = new Worker(workerUrl, { type: 'module' });\n\treturn new Promise<Worker>((resolve, reject) => {\n\t\tworker.onerror = (e) => {\n\t\t\tconst error = new Error(\n\t\t\t\t`WebWorker failed to load at ${workerUrl}. ${\n\t\t\t\t\te.message ? `Original error: ${e.message}` : ''\n\t\t\t\t}`\n\t\t\t);\n\t\t\t(error as any).filename = e.filename;\n\t\t\treject(error);\n\t\t};\n\t\t// There is no way to know when the worker script has started\n\t\t// executing, so we use a message to signal that.\n\t\tfunction onStartup(event: { data: string }) {\n\t\t\tif (event.data === 'worker-script-started') {\n\t\t\t\tresolve(worker);\n\t\t\t\tworker.removeEventListener('message', onStartup);\n\t\t\t}\n\t\t}\n\t\tworker.addEventListener('message', onStartup);\n\t});\n}\n","import {\n\tEmscripten,\n\tFSHelpers,\n\tMountHandler,\n\tPHP,\n\t__private__dont__use,\n} from '@php-wasm/universal';\nimport { Semaphore, joinPaths } from '@php-wasm/util';\nimport { logger } from '@php-wasm/logger';\nimport { FilesystemOperation, journalFSEvents } from '@php-wasm/fs-journal';\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport type * as pleaseLoadTypes from 'wicg-file-system-access';\n\ndeclare global {\n\tinterface FileSystemFileHandle {\n\t\tmove(target: FileSystemDirectoryHandle): Promise<void>;\n\t\tmove(name: string): Promise<void>;\n\t\tmove(target: FileSystemDirectoryHandle, name: string): Promise<void>;\n\t\tcreateWritable(): Promise<FileSystemWritableFileStream>;\n\t}\n\tinterface FileSystemWritableFileStream {\n\t\twrite(\n\t\t\tbuffer: BufferSource,\n\t\t\toptions?: FileSystemReadWriteOptions\n\t\t): Promise<number>;\n\t\tclose(): Promise<void>;\n\t\tseek(offset: number): Promise<void>;\n\t\ttruncate(newSize: number): Promise<void>;\n\t}\n}\n\nexport type MountDevice =\n\t| {\n\t\t\ttype: 'opfs';\n\t\t\tpath: string;\n\t  }\n\t| {\n\t\t\ttype: 'local-fs';\n\t\t\thandle: FileSystemDirectoryHandle;\n\t  };\n\nexport interface MountOptions {\n\tinitialSync: {\n\t\tdirection?: 'opfs-to-memfs' | 'memfs-to-opfs';\n\t\tonProgress?: SyncProgressCallback;\n\t};\n}\nexport type SyncProgress = {\n\t/** The number of files that have been synced. */\n\tfiles: number;\n\t/** The number of all files that need to be synced. */\n\ttotal: number;\n};\nexport type SyncProgressCallback = (progress: SyncProgress) => void;\n\nexport function createDirectoryHandleMountHandler(\n\thandle: FileSystemDirectoryHandle,\n\toptions: MountOptions = { initialSync: {} }\n): MountHandler {\n\toptions = {\n\t\t...options,\n\t\tinitialSync: {\n\t\t\t...options.initialSync,\n\t\t\tdirection: options.initialSync.direction ?? 'opfs-to-memfs',\n\t\t},\n\t};\n\n\treturn async function (php, FS, vfsMountPoint) {\n\t\tif (options.initialSync.direction === 'opfs-to-memfs') {\n\t\t\tif (FSHelpers.fileExists(FS, vfsMountPoint)) {\n\t\t\t\tFSHelpers.rmdir(FS, vfsMountPoint);\n\t\t\t}\n\t\t\tFSHelpers.mkdir(FS, vfsMountPoint);\n\t\t\tawait copyOpfsToMemfs(FS, handle, vfsMountPoint);\n\t\t} else {\n\t\t\tawait copyMemfsToOpfs(\n\t\t\t\tFS,\n\t\t\t\thandle,\n\t\t\t\tvfsMountPoint,\n\t\t\t\toptions.initialSync.onProgress\n\t\t\t);\n\t\t}\n\t\tconst unbindJournal = journalFSEventsToOpfs(php, handle, vfsMountPoint);\n\t\treturn unbindJournal;\n\t};\n}\n\nasync function copyOpfsToMemfs(\n\tFS: Emscripten.RootFS,\n\topfsRoot: FileSystemDirectoryHandle,\n\tmemfsRoot: string\n) {\n\tFSHelpers.mkdir(FS, memfsRoot);\n\n\t/**\n\t * Semaphores are used to limit the number of concurrent operations.\n\t * Flooding the browser with 2000 FS operations at the same time\n\t * can get quite slow.\n\t */\n\tconst semaphore = new Semaphore({\n\t\tconcurrency: 40,\n\t});\n\n\tconst ops: Array<Promise<void>> = [];\n\tconst stack: Array<[FileSystemDirectoryHandle, string]> = [\n\t\t[opfsRoot, memfsRoot],\n\t];\n\twhile (stack.length > 0) {\n\t\tconst [opfsParent, memfsParentPath] = stack.pop()!;\n\n\t\tfor await (const opfsHandle of opfsParent.values()) {\n\t\t\tconst op = semaphore.run(async () => {\n\t\t\t\tconst memfsEntryPath = joinPaths(\n\t\t\t\t\tmemfsParentPath,\n\t\t\t\t\topfsHandle.name\n\t\t\t\t);\n\t\t\t\tif (opfsHandle.kind === 'directory') {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tFS.mkdir(memfsEntryPath);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tif ((e as any)?.errno !== 20) {\n\t\t\t\t\t\t\tlogger.error(e);\n\t\t\t\t\t\t\t// We ignore the error if the directory already exists,\n\t\t\t\t\t\t\t// and throw otherwise.\n\t\t\t\t\t\t\tthrow e;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tstack.push([opfsHandle, memfsEntryPath]);\n\t\t\t\t} else if (opfsHandle.kind === 'file') {\n\t\t\t\t\tconst file = await opfsHandle.getFile();\n\t\t\t\t\tconst byteArray = new Uint8Array(await file.arrayBuffer());\n\t\t\t\t\tFS.createDataFile(\n\t\t\t\t\t\tmemfsParentPath,\n\t\t\t\t\t\topfsHandle.name,\n\t\t\t\t\t\tbyteArray,\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t\ttrue\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tops.splice(ops.indexOf(op), 1);\n\t\t\t});\n\t\t\tops.push(op);\n\t\t}\n\t\t// Let the ongoing operations catch-up to the stack.\n\t\twhile (stack.length === 0 && ops.length > 0) {\n\t\t\tawait Promise.any(ops);\n\t\t}\n\t}\n}\n\nexport async function copyMemfsToOpfs(\n\tFS: Emscripten.RootFS,\n\topfsRoot: FileSystemDirectoryHandle,\n\tmemfsRoot: string,\n\tonProgress?: SyncProgressCallback\n) {\n\t// Ensure the memfs directory exists.\n\tFS.mkdirTree(memfsRoot);\n\n\t// Create all MEMFS directories in OPFS but don't create\n\t// files yet. This is quite fast.\n\tconst filesToCreate: Array<[FileSystemDirectoryHandle, string, string]> =\n\t\t[];\n\tasync function mirrorMemfsDirectoryinOpfs(\n\t\tmemfsParent: string,\n\t\topfsDir: FileSystemDirectoryHandle\n\t) {\n\t\tawait Promise.all(\n\t\t\tFS.readdir(memfsParent)\n\t\t\t\t.filter(\n\t\t\t\t\t(entryName: string) =>\n\t\t\t\t\t\tentryName !== '.' && entryName !== '..'\n\t\t\t\t)\n\t\t\t\t.map(async (entryName: string) => {\n\t\t\t\t\tconst memfsPath = joinPaths(memfsParent, entryName);\n\t\t\t\t\tif (!isMemfsDir(FS, memfsPath)) {\n\t\t\t\t\t\tfilesToCreate.push([opfsDir, memfsPath, entryName]);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst handle = await opfsDir.getDirectoryHandle(entryName, {\n\t\t\t\t\t\tcreate: true,\n\t\t\t\t\t});\n\t\t\t\t\treturn await mirrorMemfsDirectoryinOpfs(memfsPath, handle);\n\t\t\t\t})\n\t\t);\n\t}\n\tawait mirrorMemfsDirectoryinOpfs(memfsRoot, opfsRoot);\n\n\t// Now let's create all the required files in OPFS. This can be quite slow\n\t// so we report progress. Throttle the progress callback to avoid flooding\n\t// the main thread with excessive updates.\n\tlet numFilesCompleted = 0;\n\tconst throttledProgressCallback = onProgress && throttle(onProgress, 100);\n\n\t// Limit max concurrent writes because Safari may otherwise encounter\n\t// an error like \"UnknownError: Invalid platform file handle\" after opening\n\t// a sufficient number of FileSyncAccessHandles (near 128).\n\t// 2024-09-21: This limit was chosen based on perceived performance while\n\t// testing with Safari, Chrome, and Firefox. It felt like a sweet spot.\n\t// Writing one-at-a-time with no concurrency had similar performance\n\t// but felt slightly slower. We can revisit and take better measurements\n\t// if needed.\n\tconst maxConcurrentWrites = 100;\n\tconst concurrentWrites = new Set();\n\n\ttry {\n\t\tfor (const [opfsDir, memfsPath, entryName] of filesToCreate) {\n\t\t\tconst promise = overwriteOpfsFile(\n\t\t\t\topfsDir,\n\t\t\t\tentryName,\n\t\t\t\tFS,\n\t\t\t\tmemfsPath\n\t\t\t).then(() => {\n\t\t\t\tnumFilesCompleted++;\n\t\t\t\tconcurrentWrites.delete(promise);\n\n\t\t\t\tthrottledProgressCallback?.({\n\t\t\t\t\tfiles: numFilesCompleted,\n\t\t\t\t\ttotal: filesToCreate.length,\n\t\t\t\t});\n\t\t\t});\n\t\t\tconcurrentWrites.add(promise);\n\n\t\t\tif (concurrentWrites.size >= maxConcurrentWrites) {\n\t\t\t\tawait Promise.race(concurrentWrites);\n\t\t\t\tthrottledProgressCallback?.({\n\t\t\t\t\tfiles: numFilesCompleted,\n\t\t\t\t\ttotal: filesToCreate.length,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t} finally {\n\t\t// Make sure all FS-related activity has completed one way or another\n\t\t// before returning. Otherwise, an error followed by a retry might lead\n\t\t// to a conflict with writes from the earlier attempt.\n\t\tawait Promise.allSettled(concurrentWrites);\n\t}\n}\n\nfunction isMemfsDir(FS: Emscripten.RootFS, path: string) {\n\treturn FS.isDir(FS.lookupPath(path, { follow: true }).node.mode);\n}\n\nasync function overwriteOpfsFile(\n\topfsParent: FileSystemDirectoryHandle,\n\tname: string,\n\tFS: Emscripten.RootFS,\n\tmemfsPath: string\n) {\n\tlet buffer;\n\ttry {\n\t\tbuffer = FS.readFile(memfsPath, {\n\t\t\tencoding: 'binary',\n\t\t});\n\t} catch (e) {\n\t\t// File was removed, ignore\n\t\treturn;\n\t}\n\n\tconst opfsFile = await opfsParent.getFileHandle(name, { create: true });\n\tconst writer =\n\t\topfsFile.createWritable !== undefined\n\t\t\t? // Google Chrome, Firefox, probably more browsers\n\t\t\t  await opfsFile.createWritable()\n\t\t\t: // Safari\n\t\t\t  await opfsFile.createSyncAccessHandle();\n\ttry {\n\t\tawait writer.truncate(0);\n\t\tawait writer.write(buffer);\n\t} finally {\n\t\tawait writer.close();\n\t}\n}\n\nexport function journalFSEventsToOpfs(\n\tphp: PHP,\n\topfsRoot: FileSystemDirectoryHandle,\n\tmemfsRoot: string\n) {\n\tconst journal: FilesystemOperation[] = [];\n\tconst unbindJournal = journalFSEvents(php, memfsRoot, (entry) => {\n\t\tjournal.push(entry);\n\t});\n\tconst rewriter = new OpfsRewriter(php, opfsRoot, memfsRoot);\n\n\tasync function flushJournal() {\n\t\tconst release = await php.semaphore.acquire();\n\t\ttry {\n\t\t\t// @TODO This is way too slow in practice, we need to batch the\n\t\t\t// changes into groups of parallelizable operations.\n\t\t\twhile (journal.length) {\n\t\t\t\tawait rewriter.processEntry(journal.shift()!);\n\t\t\t}\n\t\t} finally {\n\t\t\trelease();\n\t\t}\n\t}\n\tphp.addEventListener('request.end', flushJournal);\n\treturn function () {\n\t\tunbindJournal();\n\t\tphp.removeEventListener('request.end', flushJournal);\n\t};\n}\n\ntype JournalEntry = FilesystemOperation;\n\nclass OpfsRewriter {\n\tprivate memfsRoot: string;\n\n\tconstructor(\n\t\tprivate php: PHP,\n\t\tprivate opfs: FileSystemDirectoryHandle,\n\t\tmemfsRoot: string\n\t) {\n\t\tthis.memfsRoot = normalizeMemfsPath(memfsRoot);\n\t}\n\n\tprivate toOpfsPath(path: string) {\n\t\treturn normalizeMemfsPath(path.substring(this.memfsRoot.length));\n\t}\n\n\tpublic async processEntry(entry: JournalEntry) {\n\t\tif (\n\t\t\t!entry.path.startsWith(this.memfsRoot) ||\n\t\t\tentry.path === this.memfsRoot\n\t\t) {\n\t\t\treturn;\n\t\t}\n\t\tconst opfsPath = this.toOpfsPath(entry.path);\n\t\tconst opfsParent = await resolveParent(this.opfs, opfsPath);\n\t\tconst name = getFilename(opfsPath);\n\t\tif (!name) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tif (entry.operation === 'DELETE') {\n\t\t\t\ttry {\n\t\t\t\t\tawait opfsParent.removeEntry(name, {\n\t\t\t\t\t\trecursive: true,\n\t\t\t\t\t});\n\t\t\t\t} catch (e) {\n\t\t\t\t\t// If the directory already doesn't exist, it's fine\n\t\t\t\t}\n\t\t\t} else if (entry.operation === 'CREATE') {\n\t\t\t\tif (entry.nodeType === 'directory') {\n\t\t\t\t\tawait opfsParent.getDirectoryHandle(name, {\n\t\t\t\t\t\tcreate: true,\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tawait opfsParent.getFileHandle(name, {\n\t\t\t\t\t\tcreate: true,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else if (entry.operation === 'WRITE') {\n\t\t\t\tawait overwriteOpfsFile(\n\t\t\t\t\topfsParent,\n\t\t\t\t\tname,\n\t\t\t\t\tthis.php[__private__dont__use].FS,\n\t\t\t\t\tentry.path\n\t\t\t\t);\n\t\t\t} else if (\n\t\t\t\tentry.operation === 'RENAME' &&\n\t\t\t\tentry.toPath.startsWith(this.memfsRoot)\n\t\t\t) {\n\t\t\t\tconst opfsTargetPath = this.toOpfsPath(entry.toPath);\n\t\t\t\tconst opfsTargetParent = await resolveParent(\n\t\t\t\t\tthis.opfs,\n\t\t\t\t\topfsTargetPath\n\t\t\t\t);\n\t\t\t\tconst targetName = getFilename(opfsTargetPath);\n\n\t\t\t\tif (entry.nodeType === 'directory') {\n\t\t\t\t\tconst opfsDir = await opfsTargetParent.getDirectoryHandle(\n\t\t\t\t\t\tname,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcreate: true,\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t\t// in OPFS, move() doesn't work for directories :-(\n\t\t\t\t\t// We have to copy the directory recursively instead.\n\t\t\t\t\tawait copyMemfsToOpfs(\n\t\t\t\t\t\tthis.php[__private__dont__use].FS,\n\t\t\t\t\t\topfsDir,\n\t\t\t\t\t\tentry.toPath\n\t\t\t\t\t);\n\t\t\t\t\t// Then delete the old directory\n\t\t\t\t\tawait opfsParent.removeEntry(name, {\n\t\t\t\t\t\trecursive: true,\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst file = await opfsParent.getFileHandle(name);\n\t\t\t\t\tfile.move(opfsTargetParent, targetName);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// Useful for debugging – the original error gets lost in the\n\t\t\t// Comlink proxy.\n\t\t\tlogger.log({ entry, name });\n\t\t\tlogger.error(e);\n\t\t\tthrow e;\n\t\t}\n\t}\n}\n\nfunction normalizeMemfsPath(path: string) {\n\treturn path.replace(/\\/$/, '').replace(/\\/\\/+/g, '/');\n}\n\nfunction getFilename(path: string) {\n\treturn path.substring(path.lastIndexOf('/') + 1);\n}\n\nasync function resolveParent(\n\topfs: FileSystemDirectoryHandle,\n\trelativePath: string\n): Promise<FileSystemDirectoryHandle> {\n\tconst normalizedPath = relativePath\n\t\t.replace(/^\\/+|\\/+$/g, '')\n\t\t.replace(/\\/+/, '/');\n\tif (!normalizedPath) {\n\t\treturn opfs;\n\t}\n\tconst segments = normalizedPath.split('/');\n\tlet handle: FileSystemDirectoryHandle | FileSystemFileHandle = opfs;\n\tfor (let i = 0; i < segments.length - 1; i++) {\n\t\tconst segment = segments[i];\n\t\thandle = await handle.getDirectoryHandle(segment, { create: true });\n\t}\n\treturn handle as any;\n}\n\nfunction throttle<T extends (...args: any[]) => any>(\n\tfn: T,\n\tdebounceMs: number\n): T {\n\tlet lastCallTime = 0;\n\tlet timeoutId: ReturnType<typeof setTimeout> | undefined;\n\tlet pendingArgs: Parameters<T> | undefined;\n\n\treturn function throttledCallback(...args: Parameters<T>) {\n\t\tpendingArgs = args;\n\n\t\tconst timeSinceLastCall = Date.now() - lastCallTime;\n\t\tif (timeoutId === undefined) {\n\t\t\tconst delay = Math.max(0, debounceMs - timeSinceLastCall);\n\t\t\ttimeoutId = setTimeout(() => {\n\t\t\t\ttimeoutId = undefined;\n\t\t\t\tlastCallTime = Date.now();\n\t\t\t\tfn(...pendingArgs!);\n\t\t\t}, delay);\n\t\t}\n\t} as T;\n}\n"],"names":["consumeAPI","remote","context","setupTransferHandlers","endpoint","Comlink","api","methods","proxyClone","target","prop","runWithTimeout","promise","timeout","resolve","reject","exposeAPI","apiMethods","pipedApi","connected","setReady","setFailed","ready","exposedApi","isTransferHandlersSetup","obj","ev","port1","port2","port","responseData","PHPResponse","throwHandler","originalSerialize","value","serialized","object","args","getPHPLoaderModule","version","LatestSupportedPHPVersion","jspi","flipObject","k","v","concatUint8Arrays","arrays","totalLength","a","result","offset","concatArrayBuffers","buffers","b","as2Bytes","as3Bytes","as8Bytes","buffer","ArrayBufferReader","length","ArrayBufferWriter","ExtensionTypes","ExtensionNames","ServerNameTypes","ServerNameNames","ServerNameExtension","data","view","listLength","serverNameList","nameType","valueLength","serverNames","writer","CipherSuites","CipherSuitesNames","SupportedGroups","SupportedGroupsNames","SupportedGroupsExtension","reader","groups","group","ECPointFormats","ECPointFormatNames","ECPointFormatsExtension","formats","format","SignatureAlgorithms","SignatureAlgorithmsNames","HashAlgorithms","HashAlgorithmsNames","SignatureAlgorithmsExtension","parsedAlgorithms","hash","algorithm","logger","TLSExtensionsHandlers","parseClientHelloExtensions","parsed","initialOffset","extensionType","extensionTypeName","extensionLength","extensionBytes","handler","tls12Prf","secret","label","seed","outputLength","seedBytes","hmacKey","A","resultBuffers","hmacSha256","hmacInput","fragment","key","CompressionMethod","AlertLevels","AlertLevelNames","AlertDescriptions","AlertDescriptionNames","ContentTypes","HandshakeType","ECCurveTypes","ECNamedCurves","TLSConnectionClosed","TLS_Version_1_2","generalEcdheKeyPair","TLS_1_2_Connection","chunkStream","tlsConnection","chunk","e","certificatePrivateKey","certificatesDER","clientHelloRecord","serverRandom","MessageEncoder","ecdheKeyPair","clientRandom","serverKeyExchange","clientKeyExchangeRecord","serverPrivateKey","clientPublicKey","preMasterSecret","masterSecret","keyBlock","clientWriteKey","serverWriteKey","clientIV","serverIV","messageType","message","requestedType","record","accumulatedPayload","TLSDecoder","i","header","type","severity","description","done","requestedBytes","appData","contentType","payload","implicitIV","explicitIV","iv","decrypted","additionalData","ciphertextWithTag","cipherSuites","suite","msg_type","bodyBytes","body","buff","sessionIdLength","cipherSuitesLength","compressionMethodsLength","extensionsLength","chunkSize","controller","certsBodies","cert","certsBody","rsaPrivateKey","publicKey","params","signedParams","signatureBytes","signatureAlgorithm","clientHello","compressionAlgorithm","extensionsParts","extension","x","extensions","handshakeMessages","handshakeHash","verifyData","generateCertificate","issuerKeyPair","CertificateGenerator","certificateToPEM","certificate","formatPEM","encodeUint8ArrayAsBase64","privateKeyToPEM","privateKey","pkcs8","tbsDescription","subjectKeyPair","tbsCertificate","signature","ASN1Encoder","subjectPublicKey","serialNumber","oidByName","nameInfo","values","oidName","entry","validity","ASN1Tags","formatDateASN1","addYears","ca","pathLenConstraint","sequence","keyUsage","keyUsageBits","extKeyUsage","nsCertType","bits","altNames","generalNames","_a","name","dnsName","ipAddresses","_b","ip","ipAddress","sanExtensionValue","oids","requestedName","oid","constructedBit","tempLength","lengthBytesArray","numLengthBytes","tag","lengthBytes","number","extendedNumber","unusedBits","combined","oidParts","encodedParts","bytes","j","str","utf8Bytes","items","tagNumber","constructed","pemString","date","year","month","padNumber","day","hours","minutes","seconds","num","years","newDate","fetchWithCorsProxy","input","init","corsProxyUrl","directFetch","newInput","cloneRequest","tcpOverFetchWebsocket","tcpOptions","_","host","TCPOverFetchWebsocket","url","wsOptions","options","CAroot","outputType","wsUrl","eventName","callback","wrapper","listeners","listener","guessProtocol","siteCert","request","RawBytesFetch","HTTP_METHODS","decodedFirstLine","method","response","error","encoder","status","headersObject","headers","string","requestBytesStream","protocol","inputBuffer","requestDataExhausted","headersEndIndex","requestBytesReader","findSequenceInBuffer","headersBuffer","parsedHeaders","outboundBodyStream","hostname","httpRequestBytes","httpRequest","statusLineMaybe","path","line","bufferLength","sequenceLength","lastPossibleIndex","found","fakeWebsocket","WebSocketConstructor","loadWebRuntime","phpVersion","phpLoaderModule","websocketExtension","loadPHPRuntime","setupPostMessageRelay","nestedFrame","expectedOrigin","event","spawnPHPWorkerThread","workerUrl","worker","onStartup","createDirectoryHandleMountHandler","handle","php","FS","vfsMountPoint","FSHelpers","copyOpfsToMemfs","copyMemfsToOpfs","journalFSEventsToOpfs","opfsRoot","memfsRoot","semaphore","Semaphore","ops","stack","opfsParent","memfsParentPath","opfsHandle","op","memfsEntryPath","joinPaths","file","byteArray","onProgress","filesToCreate","mirrorMemfsDirectoryinOpfs","memfsParent","opfsDir","entryName","memfsPath","isMemfsDir","numFilesCompleted","throttledProgressCallback","throttle","maxConcurrentWrites","concurrentWrites","overwriteOpfsFile","opfsFile","journal","unbindJournal","journalFSEvents","rewriter","OpfsRewriter","flushJournal","release","opfs","normalizeMemfsPath","opfsPath","resolveParent","getFilename","__private__dont__use","opfsTargetPath","opfsTargetParent","targetName","relativePath","normalizedPath","segments","segment","fn","debounceMs","lastCallTime","timeoutId","pendingArgs","timeSinceLastCall","delay"],"mappings":"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"}